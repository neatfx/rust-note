<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>所有权 | Rust 学习笔记</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.8bcf7c97.css" as="style"><link rel="preload" href="/assets/js/app.7819f68a.js" as="script"><link rel="preload" href="/assets/js/2.c7e95d31.js" as="script"><link rel="preload" href="/assets/js/34.343562c8.js" as="script"><link rel="prefetch" href="/assets/js/10.71b7f3db.js"><link rel="prefetch" href="/assets/js/11.33bb0966.js"><link rel="prefetch" href="/assets/js/12.f7bdb846.js"><link rel="prefetch" href="/assets/js/13.14713a71.js"><link rel="prefetch" href="/assets/js/14.7a72f426.js"><link rel="prefetch" href="/assets/js/15.79443f0e.js"><link rel="prefetch" href="/assets/js/16.bfb56dec.js"><link rel="prefetch" href="/assets/js/17.c67e5630.js"><link rel="prefetch" href="/assets/js/18.28df6e14.js"><link rel="prefetch" href="/assets/js/19.6dba0f6e.js"><link rel="prefetch" href="/assets/js/20.7fe96ebb.js"><link rel="prefetch" href="/assets/js/21.c1ca2b28.js"><link rel="prefetch" href="/assets/js/22.8d30fb36.js"><link rel="prefetch" href="/assets/js/23.a04d06e6.js"><link rel="prefetch" href="/assets/js/24.8f9dbc43.js"><link rel="prefetch" href="/assets/js/25.1ab69d7f.js"><link rel="prefetch" href="/assets/js/26.9892c271.js"><link rel="prefetch" href="/assets/js/27.e2eb50d5.js"><link rel="prefetch" href="/assets/js/28.31270cab.js"><link rel="prefetch" href="/assets/js/29.e5fde72d.js"><link rel="prefetch" href="/assets/js/3.065ccf56.js"><link rel="prefetch" href="/assets/js/30.80a32322.js"><link rel="prefetch" href="/assets/js/31.827d06ec.js"><link rel="prefetch" href="/assets/js/32.b74942dc.js"><link rel="prefetch" href="/assets/js/33.db15a8db.js"><link rel="prefetch" href="/assets/js/35.c33e3c9f.js"><link rel="prefetch" href="/assets/js/36.61e40180.js"><link rel="prefetch" href="/assets/js/37.907cc52e.js"><link rel="prefetch" href="/assets/js/38.87af5dd2.js"><link rel="prefetch" href="/assets/js/39.4ee57d9f.js"><link rel="prefetch" href="/assets/js/4.4b7d39e7.js"><link rel="prefetch" href="/assets/js/40.8d7408e4.js"><link rel="prefetch" href="/assets/js/41.c2046a9f.js"><link rel="prefetch" href="/assets/js/42.6cc376da.js"><link rel="prefetch" href="/assets/js/43.63a455c5.js"><link rel="prefetch" href="/assets/js/44.0d15d778.js"><link rel="prefetch" href="/assets/js/45.9be4bc9f.js"><link rel="prefetch" href="/assets/js/46.e22e8db9.js"><link rel="prefetch" href="/assets/js/47.dbd72152.js"><link rel="prefetch" href="/assets/js/48.ec6ca506.js"><link rel="prefetch" href="/assets/js/49.22c5f8ae.js"><link rel="prefetch" href="/assets/js/5.3befbe85.js"><link rel="prefetch" href="/assets/js/50.4a58f660.js"><link rel="prefetch" href="/assets/js/51.36d42e96.js"><link rel="prefetch" href="/assets/js/52.2ec659fc.js"><link rel="prefetch" href="/assets/js/53.541947fb.js"><link rel="prefetch" href="/assets/js/54.1cf56973.js"><link rel="prefetch" href="/assets/js/55.27ed2009.js"><link rel="prefetch" href="/assets/js/56.4011a578.js"><link rel="prefetch" href="/assets/js/57.70babd7b.js"><link rel="prefetch" href="/assets/js/58.39568e0b.js"><link rel="prefetch" href="/assets/js/59.98811df6.js"><link rel="prefetch" href="/assets/js/6.fa4dd12d.js"><link rel="prefetch" href="/assets/js/60.c0a0c3f8.js"><link rel="prefetch" href="/assets/js/61.83913c6f.js"><link rel="prefetch" href="/assets/js/62.0ea87c47.js"><link rel="prefetch" href="/assets/js/7.e902d7c9.js"><link rel="prefetch" href="/assets/js/8.ac97398c.js"><link rel="prefetch" href="/assets/js/9.52c69a98.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8bcf7c97.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar"><!----> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">Rust Note</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目管理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>通用编程概念</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>所有权</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/ownership.html" class="active sidebar-link">所有权</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ownership.html#所有权规则" class="sidebar-link">所有权规则</a></li><li class="sidebar-sub-header"><a href="/ownership.html#变量作用域" class="sidebar-link">变量作用域</a></li><li class="sidebar-sub-header"><a href="/ownership.html#使用-string-类型演示所有权" class="sidebar-link">使用 String 类型演示所有权</a></li><li class="sidebar-sub-header"><a href="/ownership.html#变量与数据交互的方式" class="sidebar-link">变量与数据交互的方式</a></li><li class="sidebar-sub-header"><a href="/ownership.html#所有权与函数" class="sidebar-link">所有权与函数</a></li><li class="sidebar-sub-header"><a href="/ownership.html#返回值与作用域" class="sidebar-link">返回值与作用域</a></li><li class="sidebar-sub-header"><a href="/ownership.html#悬垂引用" class="sidebar-link">悬垂引用</a></li><li class="sidebar-sub-header"><a href="/ownership.html#引用规则" class="sidebar-link">引用规则</a></li><li class="sidebar-sub-header"><a href="/ownership.html#slice-类型" class="sidebar-link">Slice 类型</a></li><li class="sidebar-sub-header"><a href="/ownership.html#小结" class="sidebar-link">小结</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>抽象</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>生命周期</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>并发编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>测试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>模式匹配</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程范式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>高级特性</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="所有权"><a href="#所有权" class="header-anchor">#</a> 所有权</h1> <p>在 Rust 中，所有权（ Ownership ）系统存在的目的就是为了管理堆数据。所有权系统会跟踪代码使用堆数据的情况，最大限度减少重复堆数据的数量，并清理堆上不再使用的数据确保不会耗尽空间。</p> <p>作为 Rust 的核心功能，所有权系统使得 Rust 无需垃圾回收即可保证内存安全。
Rust 的解决方案是通过所有权系统对内存进行管理，编译器在编译期间对所有权规则进行检查，变量所所有的内存在变量离开作用域后将被自动释放。</p> <h2 id="所有权规则"><a href="#所有权规则" class="header-anchor">#</a> 所有权规则</h2> <ul><li>每个值都有一个被称为其所有者（ Owner ）的变量</li> <li>值有且只有一个所有者</li> <li>当所有者（ 变量 ）离开作用域，对应的值将被自动丢弃</li></ul> <h2 id="变量作用域"><a href="#变量作用域" class="header-anchor">#</a> 变量作用域</h2> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token punctuation">{</span> <span class="token comment">// 作用域开始，变量 s 尚未声明</span>
    <span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>   <span class="token comment">// 变量 s 有效</span>
    <span class="token comment">// 使用 s</span>
<span class="token punctuation">}</span> <span class="token comment">// 作用域结束，s 不再有效</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="使用-string-类型演示所有权"><a href="#使用-string-类型演示所有权" class="header-anchor">#</a> 使用 <code>String</code> 类型演示所有权</h2> <h3 id="字符串字面值"><a href="#字符串字面值" class="header-anchor">#</a> 字符串字面值</h3> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用时被硬编码进程序，字面值使用方便，但不是在任何场景下都适用，原因如下：</p> <ul><li>字符串值是不可变的</li> <li>无法保证编译时确切知道所有字符串的值（ 例如运行时的用户输入 ）</li></ul> <h3 id="字符串类型-string"><a href="#字符串类型-string" class="header-anchor">#</a> 字符串类型 <code>String</code></h3> <p><code>String</code> 类型被分配到堆上，能够存储在编译时不确定长度的文本</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// 使用 `from` 函数基于字符串字面值来创建 `String`</span>
<span class="token keyword">let</span> s <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

s<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">&quot;, world!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// push_str() 在字符串后追加字面值</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将打印 `hello, world!`</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>字符串字面值不可变而 <code>String</code> 类型可变的原因在于它们使用内存的方式不同。选择使用 <code>String</code> 类型而不是字符串字面量有利于更好的理解对所有权。</p> <h2 id="变量与数据交互的方式"><a href="#变量与数据交互的方式" class="header-anchor">#</a> 变量与数据交互的方式</h2> <p>字符串字面值使用起来快速且高效，得益于其不可变性。因为字符串字面值在编译时内容已知，文本可被直接硬编码进最终的可执行文件中。</p> <p>但是，不能为了存储编译时大小未知的文本而将一块内存放入二进制文件中，况且其大小还可能随着程序运行发生变化。</p> <p>为了支持存储可变的文本，需要在堆上分配一块在编译时大小未知的内存来存放内容，这意味着：</p> <ul><li>必须在运行时向操作系统请求内存</li> <li>需要一个方法，在处理完 <code>String</code> 时将内存返回给操作系统</li></ul> <h3 id="内存回收"><a href="#内存回收" class="header-anchor">#</a> 内存回收</h3> <h4 id="有垃圾回收机制的语言"><a href="#有垃圾回收机制的语言" class="header-anchor">#</a> 有垃圾回收机制的语言</h4> <p>GC 机制负责记录并清除不再使用的内存，程序员只负责申请使用内存</p> <h4 id="无垃圾回收机制的语言"><a href="#无垃圾回收机制的语言" class="header-anchor">#</a> 无垃圾回收机制的语言</h4> <p>程序员需要负责：</p> <ul><li>编写代码请求内存</li> <li>识别不再使用的内存</li> <li>编写用于释放内存的代码并显式调用</li></ul> <p>如果忘记回收会浪费内存，如果过早回收，将会出现无效变量。如果重复回收，也会造成 BUG。因此，在整个内存使用周期中都需要异常谨慎对待。</p> <h4 id="rust-中的内存释放机制"><a href="#rust-中的内存释放机制" class="header-anchor">#</a> Rust 中的内存释放机制</h4> <p>Rust 采取了于其他语言不同的策略 - <strong>内存在拥有它的变量离开作用域后被自动释放</strong>。当变量离开作用域时，Rust 将自动调用一个特殊的 <code>drop</code> 函数（ 该函数用于放置释放内存的代码 ）。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token punctuation">{</span> <span class="token comment">// 变量 s 尚未声明</span>
    <span class="token keyword">let</span> s <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 自该行起，变量 s 有效，String 请求其所需内存</span>
    <span class="token comment">// 使用 s</span>
<span class="token punctuation">}</span> <span class="token comment">// 作用域结束，s 不再有效，将 String 需要的内存返回给操作系统</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>该模式对编写 Rust 代码的方式有着深远的影响，尽管现在看起来很简单。</p> <h3 id="多个变量使用相同的堆内存"><a href="#多个变量使用相同的堆内存" class="header-anchor">#</a> 多个变量使用相同的堆内存</h3> <h4 id="变量与数据交互的方式-移动"><a href="#变量与数据交互的方式-移动" class="header-anchor">#</a> 变量与数据交互的方式 - 移动</h4> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// 5，存于栈中</span>
<span class="token keyword">let</span> y <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token comment">// 5，复制 x 的值，存于栈中</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>String</code> 版本：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> s1 <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> s2 <span class="token operator">=</span> s1<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>将值 <code>&quot;hello&quot;</code> 绑定到 <code>s1</code> 时， <code>String</code> 在内存中的表现形式如下图：</p> <p><code>String</code> 存储在栈上的数据由三部分组成：</p> <ul><li>一个指向存放字符串内容内存的指针</li> <li>一个长度，表示 <code>String</code> 的内容当前使用了多少字节的内存</li> <li>一个容量，表示 <code>String</code> 从操作系统总共获取了多少字节的内存</li></ul> <p>长度与容量的区别是很重要的，不过在当前上下文中并不重要，所以现在可以忽略容量。</p> <p>示意图右侧则是堆上用于存放字符串内容的内存部分。</p> <img src="images/ownership/trpl04-01.svg" style="width:50%;"> <p>将 <code>s1</code> 赋值给 <code>s2</code> 后，变量 <code>s2</code> 的内存表现：</p> <img src="images/ownership/trpl04-02.svg" style="width:50%;"> <p>变量 <code>s2</code>从栈上拷贝了变量 <code>s1</code> 的指针、长度和容量数据，但并没有复制指针指向的堆数据。</p> <p>假如 Rust 也拷贝了堆数据（ 注意：操作 <code>s2 = s1</code> 在堆数据量比较大的时候会对运行时性能造成非常大的影响 ），那么内存看起来应该是这样的：</p> <img src="images/ownership/trpl04-03.svg" style="width:50%;"> <p>已知当变量离开作用域后，Rust 会自动调用 <code>drop</code> 函数并清理变量的堆内存。这就有了一个问题：当 <code>s2</code> 和 <code>s1</code> 离开作用域，它们都会尝试释放相同的内存，这将引发<strong>二次释放</strong>的错误，可能会导致潜在的安全漏洞。</p> <p>既要避免二次释放错误，又不能简单地采取拷贝被分配的内存的方案（ 潜在的复制性能问题 ），Rust 的选择是干脆认为 <code>s1</code> 不再有效，因此不需要在 <code>s1</code> 离开作用域后对其执行清理。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> s1 <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> s2 <span class="token operator">=</span> s1<span class="token punctuation">;</span>

<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}, world!&quot;</span><span class="token punctuation">,</span> s1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>运行代码得到错误， Rust 禁止使用无效的引用：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>error<span class="token punctuation">[</span>E0382<span class="token punctuation">]</span>: use of moved value: <span class="token variable"><span class="token variable">`</span>s1<span class="token variable">`</span></span>
 --<span class="token operator">&gt;</span> src/main.rs:5:28
  <span class="token operator">|</span>
<span class="token number">3</span> <span class="token operator">|</span>     <span class="token builtin class-name">let</span> s2 <span class="token operator">=</span> s1<span class="token punctuation">;</span>
  <span class="token operator">|</span>         -- value moved here
<span class="token number">4</span> <span class="token operator">|</span>
<span class="token number">5</span> <span class="token operator">|</span>     println<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">&quot;{}, world!&quot;</span>, s1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">|</span>                            ^^ value used here after move
  <span class="token operator">|</span>
  <span class="token operator">=</span> note: move occurs because <span class="token variable"><span class="token variable">`</span>s1<span class="token variable">`</span></span> has <span class="token builtin class-name">type</span> <span class="token variable"><span class="token variable">`</span>std::string::String<span class="token variable">`</span></span>, <span class="token function">which</span> does
  not implement the <span class="token variable"><span class="token variable">`</span>Copy<span class="token variable">`</span></span> trait
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>拷贝指针、长度和容量而不拷贝数据听起来像浅拷贝，但因 Rust 同时使 <code>s1</code> 变量无效了，这个操作被称为移动（ move ）而不是浅拷贝。上面的例子可以解读为 <code>s1</code> 被移动到了 <code>s2</code> 中，如下图所示：</p> <img src="images/ownership/trpl04-04.svg" style="width:50%;"> <p>另外，这里还隐含了一个设计选择：Rust 永远不会自动创建数据的 “深拷贝”。因此，任何自动的复制操作可以被认为对运行时性能影响较小。</p> <h4 id="变量与数据交互的方式-复制"><a href="#变量与数据交互的方式-复制" class="header-anchor">#</a> 变量与数据交互的方式 - 复制</h4> <p>如果确实需要深度复制堆数据，而不仅仅是栈上的数据，可以使用通用函数 <code>clone</code>：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> s1 <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> s2 <span class="token operator">=</span> s1<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;s1 = {}, s2 = {}&quot;</span><span class="token punctuation">,</span> s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>以下代码没有调用 <code>clone</code>，不过 <code>x</code> 依然有效且没有被移动到 <code>y</code> 中：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> y <span class="token operator">=</span> x<span class="token punctuation">;</span>

<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;x = {}, y = {}&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>原因在于，对于整型这种编译时已知大小、只使用栈来存储数据的类型，值拷贝是非常快的，也就不存在深浅拷贝的区别，使用 <code>clone</code> 的效果也与浅拷贝没有什么不同。</p> <h5 id="所有权系统中的drop-特质与copy-特质"><a href="#所有权系统中的drop-特质与copy-特质" class="header-anchor">#</a> 所有权系统中的<code>Drop</code> 特质与<code>Copy</code> 特质</h5> <p>在 Rust 中，如果一个类型具有 <code>Copy</code> 特质，旧变量在将其赋值给其他变量后仍然可用。Rust 不允许自身或其任何部分实现了 <code>Drop</code> 特质的类型使用 <code>Copy</code> 特质。如果对离开作用域时需特殊处理（ <code>drop</code> ）的类型使用 <code>Copy</code> 注解，将引发编译时错误。</p> <p>任何简单标量值的组合可以是 <code>Copy</code> 的，不需要分配内存或某种形式资源的类型是 <code>Copy</code> 的：</p> <ul><li>所有整数类型</li> <li>布尔类型 <code>bool</code></li> <li>所有浮点数类型</li> <li>字符类型 <code>char</code></li> <li>元组（ 当且仅当其包含的类型也是 <code>Copy</code> 时 ）。例如 <code>(i32, i32)</code> 是，<code>(i32, String)</code> 不是</li></ul> <h2 id="所有权与函数"><a href="#所有权与函数" class="header-anchor">#</a> 所有权与函数</h2> <p>将值传递给函数在语义上与变量赋值相似，可能会发生移动或者复制。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> s <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// s 进入作用域</span>

    <span class="token function">takes_ownership</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// s 的值移动到函数里</span>
    <span class="token comment">// 到这里 s 不再有效</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// x 进入作用域</span>

    <span class="token function">makes_copy</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// x 应该移动到函数里，但 i32 是 Copy 的，所以后面可继续使用 x</span>
<span class="token punctuation">}</span> <span class="token comment">// 此处，x 先离开作用域，然后是 s。但因为 s 的值已被移走，所以不会有特殊操作（ drop ）</span>

<span class="token keyword">fn</span> <span class="token function">takes_ownership</span><span class="token punctuation">(</span>some_string<span class="token punctuation">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// some_string 进入作用域</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> some_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token comment">// 此处，some_string 离开作用域并调用 `drop` 方法，占用的内存被释放</span>

<span class="token keyword">fn</span> <span class="token function">makes_copy</span><span class="token punctuation">(</span>some_integer<span class="token punctuation">:</span> i32<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// some_integer 进入作用域</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> some_integer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token comment">// 此处，some_integer 离开作用域，不会有特殊操作</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="返回值与作用域"><a href="#返回值与作用域" class="header-anchor">#</a> 返回值与作用域</h2> <p>返回值也可以转移所有权</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> s1 <span class="token operator">=</span> <span class="token function">gives_ownership</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 函数将返回值移给 s1</span>
    <span class="token keyword">let</span> s2 <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// s2 进入作用域</span>
    <span class="token keyword">let</span> s3 <span class="token operator">=</span> <span class="token function">takes_and_gives_back</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// s2 被移动进函数，函数将返回值移给 s3</span>
<span class="token punctuation">}</span> <span class="token comment">// 此处，s3 被丢弃。s2 已被移走，不进行特殊操作。s1 被丢弃</span>

<span class="token keyword">fn</span> <span class="token function">gives_ownership</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> String <span class="token punctuation">{</span> <span class="token comment">// gives_ownership 将返回值移动给调用它的函数</span>
    <span class="token keyword">let</span> some_string <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// some_string 进入作用域.</span>

    some_string <span class="token comment">// 返回 some_string 并移出给调用的函数</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">takes_and_gives_back</span><span class="token punctuation">(</span>a_string<span class="token punctuation">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> String <span class="token punctuation">{</span> <span class="token comment">// a_string 进入作用域</span>
    a_string  <span class="token comment">// 返回 a_string 并移出给调用的函数</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>变量的所有权总是遵循相同的模式，即将值赋给另一个变量时移动它。当持有堆中数据值的变量离开作用域时，其值将通过 <code>drop</code> 被清理掉，除非数据被移动为另一个变量所有。</p> <h3 id="使用元组返回多个值"><a href="#使用元组返回多个值" class="header-anchor">#</a> 使用元组返回多个值</h3> <p>如果想让函数使用某个值但不获取其所有权（ 以便于之后继续使用 ），先获取所有权再返回所有权的方式显然比较啰嗦。另一方面，从函数中返回数据也很常见。同时满足这两者，可以使用元组：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> s1 <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>s2<span class="token punctuation">,</span> len<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">calculate_length</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;The length of '{}' is {}.&quot;</span><span class="token punctuation">,</span> s2<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">calculate_length</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token punctuation">(</span>String<span class="token punctuation">,</span> usize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> length <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// len() 返回字符串的长度</span>

    <span class="token punctuation">(</span>s<span class="token punctuation">,</span> length<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>此方案的问题在于，必须将 <code>String</code> 返回以便在调用 <code>calculate_length</code> 后仍能使用 <code>String</code>，因为 <code>String</code> 被移动到了 <code>calculate_length</code> 内，函数仍然获取了值的所有权。</p> <h3 id="引用"><a href="#引用" class="header-anchor">#</a> 引用</h3> <p>使用 <code>&amp;</code> 符号表示引用（ References ），引用允许使用值但不获取其所有权。与引用相反的操作是解引用（ Dereferencing ），使用解引用运算符 <code>*</code> 表示。</p> <p>引用在默认情况下是不可变的。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> s1 <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> len <span class="token operator">=</span> <span class="token function">calculate_length</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// `&amp;s1` 语法创建一个指向值 `s1` 的引用</span>

    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;The length of '{}' is {}.&quot;</span><span class="token punctuation">,</span> s1<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 参数 s 只是指向值 `s1` 的引用，并不拥有引用值的所有权</span>
<span class="token keyword">fn</span> <span class="token function">calculate_length</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span>String<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> usize <span class="token punctuation">{</span>
    s<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token comment">// 引用 s 离开作用域，不会有特殊操作（ drop ），其指向的值不会被丢弃</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><img src="images/ownership/trpl04-05.svg"> <p>当函数使用引用而不是实际值作为参数，无需返回值来交还所有权，因为其不曾拥有所有权。</p> <h3 id="借用（-borrowing-）"><a href="#借用（-borrowing-）" class="header-anchor">#</a> 借用（ Borrowing ）</h3> <p>借用是指获取引用作为函数参数的行为，在借用期间不允许修改引用（ 默认不可变 ）的值。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> s <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">change</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">change</span><span class="token punctuation">(</span>some_string<span class="token punctuation">:</span> <span class="token operator">&amp;</span>String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    some_string<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">&quot;, world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>error<span class="token punctuation">[</span>E0596<span class="token punctuation">]</span>: cannot borrow immutable borrowed content <span class="token variable"><span class="token variable">`</span>*some_string<span class="token variable">`</span></span> as mutable
 --<span class="token operator">&gt;</span> error.rs:8:5
  <span class="token operator">|</span>
<span class="token number">7</span> <span class="token operator">|</span> fn change<span class="token punctuation">(</span>some_string: <span class="token operator">&amp;</span>String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">|</span>                        ------- use <span class="token variable"><span class="token variable">`</span><span class="token operator">&amp;</span>mut String<span class="token variable">`</span></span> here to <span class="token function">make</span> mutable
<span class="token number">8</span> <span class="token operator">|</span>     some_string.push_str<span class="token punctuation">(</span><span class="token string">&quot;, world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">|</span>     ^^^^^^^^^^^ cannot borrow as mutable
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="可变引用"><a href="#可变引用" class="header-anchor">#</a> 可变引用</h3> <p>使用可变引用可以实现修改引用的值：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">change</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">change</span><span class="token punctuation">(</span>some_string<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    some_string<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">&quot;, world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>不过，可变引用有一个很大的限制：<strong>在特定作用域中的特定数据有且只能有一个可变引用</strong>。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> r1 <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">;</span>
<span class="token keyword">let</span> r2 <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">;</span>

<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}, {}&quot;</span><span class="token punctuation">,</span> r1<span class="token punctuation">,</span> r2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>运行代码：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>error<span class="token punctuation">[</span>E0499<span class="token punctuation">]</span>: cannot borrow <span class="token variable"><span class="token variable">`</span>s<span class="token variable">`</span></span> as mutable <span class="token function">more</span> than once at a <span class="token function">time</span>
 --<span class="token operator">&gt;</span> src/main.rs:5:10
  <span class="token operator">|</span>
<span class="token number">4</span> <span class="token operator">|</span> <span class="token builtin class-name">let</span> r1 <span class="token operator">=</span> <span class="token operator">&amp;</span>mut s<span class="token punctuation">;</span>
  <span class="token operator">|</span>          ------ first mutable borrow occurs here
<span class="token number">5</span> <span class="token operator">|</span> <span class="token builtin class-name">let</span> r2 <span class="token operator">=</span> <span class="token operator">&amp;</span>mut s<span class="token punctuation">;</span>
  <span class="token operator">|</span>          ^^^^^^ second mutable borrow occurs here
<span class="token number">6</span> <span class="token operator">|</span> println<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">&quot;{}, {}&quot;</span>, r1, r2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">|</span>                    -- borrow later used here
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>此限制的好处是使 Rust 可以在编译时避免数据竞争的情况：</p> <ul><li>两个或更多指针同时访问同一数据</li> <li>至少有一个指针被用来写入数据</li> <li>没有同步数据访问的机制</li></ul> <p>数据竞争会导致程序出现难以捕捉的异常行为，修复起来很困难，而存在数据竞争的代码在 Rust 中根本无法通过编译，从而也就避免了此类问题的发生！</p> <p>同一变量存在多个可变引用（ 实际上并非同时引用 ）：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">{</span> <span class="token comment">// 大括号开启新的作用域</span>
    <span class="token keyword">let</span> r1 <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">;</span>

<span class="token punctuation">}</span> <span class="token comment">// r1 离开作用域，所以可以创建一个新的引用</span>

<span class="token keyword">let</span> r2 <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>同一变量不能在拥有不可变引用的同时拥有可变引用，以下代码会导致编译时错误：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> r1 <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">;</span> <span class="token comment">// no problem</span>
<span class="token keyword">let</span> r2 <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">;</span> <span class="token comment">// no problem</span>
<span class="token keyword">let</span> r3 <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">;</span> <span class="token comment">// BIG PROBLEM</span>

<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}, {}, and {}&quot;</span><span class="token punctuation">,</span> r1<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> r3<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>错误如下：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>error<span class="token punctuation">[</span>E0502<span class="token punctuation">]</span>: cannot borrow <span class="token variable"><span class="token variable">`</span>s<span class="token variable">`</span></span> as mutable because it is also borrowed as immutable
 --<span class="token operator">&gt;</span> src/main.rs:6:10
  <span class="token operator">|</span>
<span class="token number">4</span> <span class="token operator">|</span> <span class="token builtin class-name">let</span> r1 <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">;</span> // no problem
  <span class="token operator">|</span>          -- immutable borrow occurs here
<span class="token number">5</span> <span class="token operator">|</span> <span class="token builtin class-name">let</span> r2 <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">;</span> // no problem
<span class="token number">6</span> <span class="token operator">|</span> <span class="token builtin class-name">let</span> r3 <span class="token operator">=</span> <span class="token operator">&amp;</span>mut s<span class="token punctuation">;</span> // BIG PROBLEM
  <span class="token operator">|</span>          ^^^^^^ mutable borrow occurs here
<span class="token number">7</span> <span class="token operator">|</span>
<span class="token number">8</span> <span class="token operator">|</span> println<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">&quot;{}, {}, and {}&quot;</span>, r1, r2, r3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">|</span>                            -- borrow later used here
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>尽管以上限制容易引发错误造成困扰，但是 Rust 编译器能够在编译时准确地指出代码中的潜在问题，不仅帮助更快的处理错误，更避免了把这些难以跟踪的错误放到运行时解决。</p> <h2 id="悬垂引用"><a href="#悬垂引用" class="header-anchor">#</a> 悬垂引用</h2> <p>在有指针的语言中，释放内存的同时如果还存在指向该内存的指针，则很容易形成悬垂指针。</p> <p>在 Rust 中，编译器确保引用永远不会变成悬垂状态，即不会有悬垂引用（ Dangling References ）。引用一旦开始，编译器会确保引用的数据不会在引用之前离开作用域。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> reference_to_nothing <span class="token operator">=</span> <span class="token function">dangle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">dangle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span>String <span class="token punctuation">{</span> <span class="token comment">// dangle 函数返回一个字符串的引用</span>

    <span class="token keyword">let</span> s <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符串</span>

    <span class="token operator">&amp;</span>s <span class="token comment">// 返回字符串 s 的引用</span>
<span class="token punctuation">}</span> <span class="token comment">// s 离开作用域，并被丢弃，其内存被释放，reference_to_nothing 成为悬垂引用</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>运行代码：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>error<span class="token punctuation">[</span>E0106<span class="token punctuation">]</span>: missing lifetime specifier
 --<span class="token operator">&gt;</span> main.rs:5:16
  <span class="token operator">|</span>
<span class="token number">5</span> <span class="token operator">|</span> fn dangle<span class="token punctuation">(</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>String <span class="token punctuation">{</span>
  <span class="token operator">|</span>                ^ expected lifetime parameter
  <span class="token operator">|</span>
  <span class="token operator">=</span> help: this <span class="token keyword">function</span><span class="token string">'s return type contains a borrowed value, but there is
  no value for it to be borrowed from
  = help: consider giving it a '</span>static lifetime
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>修正代码：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// 直接返回 `String` ，所有权被移出函数，没有值被释放，没有悬垂引用。</span>
<span class="token keyword">fn</span> <span class="token function">no_dangle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> String <span class="token punctuation">{</span>
    <span class="token keyword">let</span> s <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    s
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="引用规则"><a href="#引用规则" class="header-anchor">#</a> 引用规则</h2> <ul><li>在任意给定时间，要么只能有一个可变引用，要么只能有多个不可变引用</li> <li>引用必须总是有效</li></ul> <h2 id="slice-类型"><a href="#slice-类型" class="header-anchor">#</a> <code>Slice</code> 类型</h2> <p><code>Slice</code> 是没有所有权的数据类型，用于引用集合中一段连续的元素序列，而不是整个集合。</p> <p>编写函数：接收字符串并返回在字符串中找到的第一个单词，如果未找到空格，返回整个字符串。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// 因为不需要获取所有权，所以参数类型为 &amp;String</span>
<span class="token comment">// 暂时没有获取部分字符串的方法，所以使用 &amp;str 代替，返回单词结尾的索引</span>
<span class="token keyword">fn</span> <span class="token function">first_word</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span>String<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> usize <span class="token punctuation">{</span>
    <span class="token keyword">let</span> bytes <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将 String 转化为字节数组</span>

    <span class="token comment">// iter 方法返回集合中的每一个元素，enumerate 则包装 iter 的结果并返回一个元组</span>
    <span class="token comment">// 元组的第一个元素是索引，第二个元素是集合中元素的引用</span>
    <span class="token comment">// 在 for 循环中，指定模式，元组中的 i 是索引，元组中的 &amp;item 是单个字节</span>
    <span class="token comment">// 因为从 .iter().enumerate() 中获取了集合元素的引用，所以模式中使用 &amp;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>item<span class="token punctuation">)</span> <span class="token keyword">in</span> bytes<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 通过字节的字面值语法来寻找代表空格的字节。如果找到空格，返回其位置。</span>
        <span class="token comment">// 否则，使用 s.len() 返回字符串的长度</span>
        <span class="token keyword">if</span> item <span class="token operator">==</span> <span class="token char string">b' '</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    s<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> word <span class="token operator">=</span> <span class="token function">first_word</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// word 的值为 5</span>

    s<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 清空字符串，使其等于 &quot;&quot;</span>

    <span class="token comment">// 函数调用结束后，`word` 与 `s` 不再关联，`word` 值不会跟随 `s` 的值变化</span>
    <span class="token comment">// word 在此处的值仍然是 5</span>
    <span class="token comment">// 但是如果尝试用值 5 来提取变量 s 的第一个单词，将会产生 BUG，因为此时 s 的内容已经改变！</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>如果函数可以返回 <code>s</code> 的部分引用，就可以实现 <code>word</code> 与 <code>s</code> 保持关联。</p> <h3 id="字符串-slice"><a href="#字符串-slice" class="header-anchor">#</a> 字符串 Slice</h3> <p>字符串 <code>Slice</code> 是对 <code>String</code> 中部分值的引用，其类型声明写作 <code>&amp;str</code>。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> s <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> hello <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> world <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">..</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> hello <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">..=</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> world <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">..=</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>[start..end]</code> 语法表示从 <code>start</code> 开头到 <code>end</code>（ 不含 <code>end</code> ），如需要包含 <code>end</code>，可使用 <code>..=</code></p> <p><code>let world = &amp;s[6..=10];</code> 等同于 <code>let world = &amp;s[6..11]</code>，如下图所示：</p> <img src="images/ownership/trpl04-06.svg" style="width:50%;"> <h4 id="语法省略"><a href="#语法省略" class="header-anchor">#</a> 语法省略</h4> <p>如果从索引 0 开始，可以不写两个点号之前的值：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> s <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> slice <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> slice <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如果 <code>slice</code> 包含 <code>String</code> 的最后一个字节，可以省略尾部的数字：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> s <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> len <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> slice <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">..</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> slice <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>获取整个字符串时：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> s <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> len <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> slice <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">..</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> slice <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>注意：字符串 slice range 的索引必须位于有效的 UTF-8 字符边界内，如果尝试从一个多字节字符的中间位置创建字符串 slice，则程序将会因错误而退出。出于介绍字符串 slice 的目的，本部分假设只使用 ASCII 字符集；第八章的 “使用字符串存储 UTF-8 编码的文本” 部分会更加全面的讨论 UTF-8 处理问题。</p></blockquote> <p>使用字符串 <code>slice</code> 重写 <code>first_word</code> 函数：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">first_word</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span>String<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span>str <span class="token punctuation">{</span>
    <span class="token keyword">let</span> bytes <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>item<span class="token punctuation">)</span> <span class="token keyword">in</span> bytes<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> item <span class="token operator">==</span> <span class="token char string">b' '</span> <span class="token punctuation">{</span>
            <span class="token comment">// 返回一个使用字符串的开始和空格的索引作为开始和结束的索引的字符串 slice</span>
            <span class="token keyword">return</span> <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">..</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>函数调用：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> word <span class="token operator">=</span> <span class="token function">first_word</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &amp;s 为不可变引用</span>

    <span class="token comment">// 因为 clear 需要清空 String</span>
    <span class="token comment">// 它尝试获取 s 的可变引用，而 s 已经有一个不可变引用，这违反了借用规则，因此失败了。</span>
    s<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// error!</span>

    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;the first word is: {}&quot;</span><span class="token punctuation">,</span> word<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>得到编译错误：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>error<span class="token punctuation">[</span>E0502<span class="token punctuation">]</span>: cannot borrow <span class="token variable"><span class="token variable">`</span>s<span class="token variable">`</span></span> as mutable because it is also borrowed as immutable
  --<span class="token operator">&gt;</span> src/main.rs:10:5
   <span class="token operator">|</span>
<span class="token number">8</span>  <span class="token operator">|</span>     <span class="token builtin class-name">let</span> word <span class="token operator">=</span> first_word<span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token operator">|</span>                           -- immutable borrow occurs here
<span class="token number">9</span>  <span class="token operator">|</span>
<span class="token number">10</span> <span class="token operator">|</span>     s.clear<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> // error<span class="token operator">!</span>
   <span class="token operator">|</span>     ^^^^^^^^^ mutable borrow occurs here
<span class="token number">11</span> <span class="token operator">|</span>
<span class="token number">12</span> <span class="token operator">|</span>     println<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">&quot;the first word is: {}&quot;</span>, word<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token operator">|</span>                                       ---- borrow later used here
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>对比两个版本的 <code>first_word</code> 函数：</p> <p>之前版本的代码可以编译，但当使用之前获取的索引访问已经发生变化的字符串时，问题才会出现。</p> <p>而 <code>Slice</code> 版本的函数，不仅代码更加简单通用，Rust 编译器还会提醒潜在的借用错误。</p> <h4 id="字符串字面值就是-slice"><a href="#字符串字面值就是-slice" class="header-anchor">#</a> 字符串字面值就是 <code>Slice</code></h4> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token string">&quot;Hello, world!&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 不可变引用类型 `&amp;str`</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>s</code> 是指向二进制程序特定位置的 <code>slice</code>，这也是为什么字符串字面值是不可变的原因。</p> <h4 id="字符串-slice-作为参数"><a href="#字符串-slice-作为参数" class="header-anchor">#</a> 字符串 slice 作为参数</h4> <p>再次改进 <code>first_word</code> 函数：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// 可以接受 String 值和 &amp;str 值作为参数，函数变得更加通用</span>
<span class="token comment">// 字符串 slice 可以直接作为参数，如果有一个 String，则可以传递整个 String 的 slice</span>
<span class="token keyword">fn</span> <span class="token function">first_word</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span>str <span class="token punctuation">{</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">first_word</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span>str <span class="token punctuation">{</span>
    <span class="token keyword">let</span> bytes <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>item<span class="token punctuation">)</span> <span class="token keyword">in</span> bytes<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> item <span class="token operator">==</span> <span class="token char string">b' '</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">..</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token operator">&amp;</span>s<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> my_string <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// first_word 中传入 `String` 的 slice</span>
    <span class="token keyword">let</span> word <span class="token operator">=</span> <span class="token function">first_word</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_string<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> my_string_literal <span class="token operator">=</span> <span class="token string">&quot;hello world&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// first_word 中传入字符串字面值的 slice</span>
    <span class="token keyword">let</span> word <span class="token operator">=</span> <span class="token function">first_word</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_string_literal<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 因为字符串字面值 **就是** 字符串 slice，</span>
    <span class="token comment">// 这样写也可以，即不使用 slice 语法！</span>
    <span class="token keyword">let</span> word <span class="token operator">=</span> <span class="token function">first_word</span><span class="token punctuation">(</span>my_string_literal<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="其他类型的-slice"><a href="#其他类型的-slice" class="header-anchor">#</a> 其他类型的 <code>Slice</code></h3> <p>引用数组的一部分：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> slice <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// slice 的类型是 `&amp;[i32]`</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>数组 <code>slice</code> 与字符串 <code>slice</code> 的工作方式相同，即存储第一个集合元素的引用和一个集合总长度。可以对其他所有集合使用这类 <code>Slice</code>。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>借助于所有权、借用、<code>Slice</code> 这些概念， Rust 在编译时确保内存安全。</p> <p>Rust 使用与其他系统编程语言相同的方式来申请、操作内存，但同时具备在数据所有者离开作用域后自动清除其数据的功能，这意味着无须额外编写、调用与内存回收相关的代码。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/comment.html" class="prev">注释</a></span> <span class="next"><a href="/generic-type.html">泛型</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7819f68a.js" defer></script><script src="/assets/js/2.c7e95d31.js" defer></script><script src="/assets/js/34.343562c8.js" defer></script>
  </body>
</html>
