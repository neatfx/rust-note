<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>引用计数智能指针 Rc&lt;T&gt; | Rust 学习笔记</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.8bcf7c97.css" as="style"><link rel="preload" href="/assets/js/app.7819f68a.js" as="script"><link rel="preload" href="/assets/js/2.c7e95d31.js" as="script"><link rel="preload" href="/assets/js/52.2ec659fc.js" as="script"><link rel="prefetch" href="/assets/js/10.71b7f3db.js"><link rel="prefetch" href="/assets/js/11.33bb0966.js"><link rel="prefetch" href="/assets/js/12.f7bdb846.js"><link rel="prefetch" href="/assets/js/13.14713a71.js"><link rel="prefetch" href="/assets/js/14.7a72f426.js"><link rel="prefetch" href="/assets/js/15.79443f0e.js"><link rel="prefetch" href="/assets/js/16.bfb56dec.js"><link rel="prefetch" href="/assets/js/17.c67e5630.js"><link rel="prefetch" href="/assets/js/18.28df6e14.js"><link rel="prefetch" href="/assets/js/19.6dba0f6e.js"><link rel="prefetch" href="/assets/js/20.7fe96ebb.js"><link rel="prefetch" href="/assets/js/21.c1ca2b28.js"><link rel="prefetch" href="/assets/js/22.8d30fb36.js"><link rel="prefetch" href="/assets/js/23.a04d06e6.js"><link rel="prefetch" href="/assets/js/24.8f9dbc43.js"><link rel="prefetch" href="/assets/js/25.1ab69d7f.js"><link rel="prefetch" href="/assets/js/26.9892c271.js"><link rel="prefetch" href="/assets/js/27.e2eb50d5.js"><link rel="prefetch" href="/assets/js/28.31270cab.js"><link rel="prefetch" href="/assets/js/29.e5fde72d.js"><link rel="prefetch" href="/assets/js/3.065ccf56.js"><link rel="prefetch" href="/assets/js/30.80a32322.js"><link rel="prefetch" href="/assets/js/31.827d06ec.js"><link rel="prefetch" href="/assets/js/32.b74942dc.js"><link rel="prefetch" href="/assets/js/33.db15a8db.js"><link rel="prefetch" href="/assets/js/34.343562c8.js"><link rel="prefetch" href="/assets/js/35.c33e3c9f.js"><link rel="prefetch" href="/assets/js/36.61e40180.js"><link rel="prefetch" href="/assets/js/37.907cc52e.js"><link rel="prefetch" href="/assets/js/38.87af5dd2.js"><link rel="prefetch" href="/assets/js/39.4ee57d9f.js"><link rel="prefetch" href="/assets/js/4.4b7d39e7.js"><link rel="prefetch" href="/assets/js/40.8d7408e4.js"><link rel="prefetch" href="/assets/js/41.c2046a9f.js"><link rel="prefetch" href="/assets/js/42.6cc376da.js"><link rel="prefetch" href="/assets/js/43.63a455c5.js"><link rel="prefetch" href="/assets/js/44.0d15d778.js"><link rel="prefetch" href="/assets/js/45.9be4bc9f.js"><link rel="prefetch" href="/assets/js/46.e22e8db9.js"><link rel="prefetch" href="/assets/js/47.dbd72152.js"><link rel="prefetch" href="/assets/js/48.ec6ca506.js"><link rel="prefetch" href="/assets/js/49.22c5f8ae.js"><link rel="prefetch" href="/assets/js/5.3befbe85.js"><link rel="prefetch" href="/assets/js/50.4a58f660.js"><link rel="prefetch" href="/assets/js/51.36d42e96.js"><link rel="prefetch" href="/assets/js/53.541947fb.js"><link rel="prefetch" href="/assets/js/54.1cf56973.js"><link rel="prefetch" href="/assets/js/55.27ed2009.js"><link rel="prefetch" href="/assets/js/56.4011a578.js"><link rel="prefetch" href="/assets/js/57.70babd7b.js"><link rel="prefetch" href="/assets/js/58.39568e0b.js"><link rel="prefetch" href="/assets/js/59.98811df6.js"><link rel="prefetch" href="/assets/js/6.fa4dd12d.js"><link rel="prefetch" href="/assets/js/60.c0a0c3f8.js"><link rel="prefetch" href="/assets/js/61.83913c6f.js"><link rel="prefetch" href="/assets/js/62.0ea87c47.js"><link rel="prefetch" href="/assets/js/7.e902d7c9.js"><link rel="prefetch" href="/assets/js/8.ac97398c.js"><link rel="prefetch" href="/assets/js/9.52c69a98.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8bcf7c97.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar"><!----> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">Rust Note</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目管理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>通用编程概念</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/variable.html" class="sidebar-link">变量与可变性</a></li><li><a href="/data-type.html" class="sidebar-link">数据类型</a></li><li><a href="/struct.html" class="sidebar-link">结构体</a></li><li><a href="/enumeration.html" class="sidebar-link">枚举</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/collections/" class="sidebar-heading clickable"><span>集合</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/smart-pointer/" class="sidebar-heading clickable router-link-active open"><span>智能指针</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/smart-pointer/box.html" class="sidebar-link">使用 Box&lt;T&gt; 在堆上存储数据</a></li><li><a href="/smart-pointer/deref-trait.html" class="sidebar-link">利用 Deref 特质进行常规引用操作</a></li><li><a href="/smart-pointer/drop-trait.html" class="sidebar-link">利用 Drop 特质进行清理</a></li><li><a href="/smart-pointer/rc.html" class="active sidebar-link">引用计数智能指针 Rc&lt;T&gt;</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/smart-pointer/rc.html#适用场景" class="sidebar-link">适用场景</a></li><li class="sidebar-sub-header"><a href="/smart-pointer/rc.html#共享数据" class="sidebar-link">共享数据</a></li><li class="sidebar-sub-header"><a href="/smart-pointer/rc.html#引用计数" class="sidebar-link">引用计数</a></li></ul></li><li><a href="/smart-pointer/refcell.html" class="sidebar-link">@ 内部可变性模式</a></li><li><a href="/smart-pointer/reference-cycles-and-memory-leak.html" class="sidebar-link">@ 引用循环与内存泄漏</a></li></ul></section></li><li><a href="/function.html" class="sidebar-link">函数</a></li><li><a href="/control-flow.html" class="sidebar-link">流程控制</a></li><li><a href="/error-handling.html" class="sidebar-link">错误处理</a></li><li><a href="/comment.html" class="sidebar-link">注释</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>所有权</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>抽象</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>生命周期</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>并发编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>测试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>模式匹配</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程范式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>高级特性</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="引用计数智能指针-rc-t"><a href="#引用计数智能指针-rc-t" class="header-anchor">#</a> 引用计数智能指针 <code>Rc&lt;T&gt;</code></h1> <p>引用计数智能指针允许值有多个所有者，对值的所有者进行计数，并在计数为 0 时负责清理数据。</p> <p>大部分情况下所有权是非常明确的，可以准确的知道哪个变量拥有某个值。然而，有些情况下单个值可能会有多个所有者。Rust 通过 <code>Rc&lt;T&gt;</code> 类型启用多所有权，<code>Rc</code> 为引用计数（ reference counting ）的缩写，引用计数意味着通过记录值的引用数量来判断值是否仍被使用。如果某个值有 0 个引用，则表示其没有任何有效引用并可以被清理。</p> <h2 id="适用场景"><a href="#适用场景" class="header-anchor">#</a> 适用场景</h2> <p>适用于当希望在堆上分配内存供程序的多个部分读取，且无法在编译时确定程序的哪一部分会最后结束使用它的时候。如果明确知道哪部分会结束使用的话，就可以令其成为数据的所有者同时正常的所有权规则就可以在编译时生效。</p> <p>仅适用于单线程场景</p> <h2 id="共享数据"><a href="#共享数据" class="header-anchor">#</a> 共享数据</h2> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">enum</span> List <span class="token punctuation">{</span>
    <span class="token function">Cons</span><span class="token punctuation">(</span>i32<span class="token punctuation">,</span> Box<span class="token operator">&lt;</span>List<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Nil<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">use</span> List<span class="token punctuation">::</span><span class="token punctuation">{</span>Cons<span class="token punctuation">,</span> Nil<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span>
        Box<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span>
            Box<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>Nil<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> Box<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> Box<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>编译错误：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>error<span class="token punctuation">[</span>E0382<span class="token punctuation">]</span>: use of moved value: <span class="token variable"><span class="token variable">`</span>a<span class="token variable">`</span></span>
  --<span class="token operator">&gt;</span> src/main.rs:13:30
   <span class="token operator">|</span>
<span class="token number">12</span> <span class="token operator">|</span>     <span class="token builtin class-name">let</span> b <span class="token operator">=</span> Cons<span class="token punctuation">(</span><span class="token number">3</span>, Box::new<span class="token punctuation">(</span>a<span class="token punctuation">))</span><span class="token punctuation">;</span>
   <span class="token operator">|</span>                              - value moved here
<span class="token number">13</span> <span class="token operator">|</span>     <span class="token builtin class-name">let</span> c <span class="token operator">=</span> Cons<span class="token punctuation">(</span><span class="token number">4</span>, Box::new<span class="token punctuation">(</span>a<span class="token punctuation">))</span><span class="token punctuation">;</span>
   <span class="token operator">|</span>                              ^ value used here after move
   <span class="token operator">|</span>
   <span class="token operator">=</span> note: move occurs because <span class="token variable"><span class="token variable">`</span>a<span class="token variable">`</span></span> has <span class="token builtin class-name">type</span> <span class="token variable"><span class="token variable">`</span>List<span class="token variable">`</span></span>, <span class="token function">which</span> does not implement
   the <span class="token variable"><span class="token variable">`</span>Copy<span class="token variable">`</span></span> trait
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Cons 成员拥有其储存的数据，所以当创建 b 列表时，a 被移动进了 b 这样 b 就拥有了 a。接着当再次尝使用 a 创建 c 时，这不被允许因为 a 的所有权已经被移动。</p> <p>可以改变 Cons 的定义来存放一个引用，不过接着必须指定生命周期参数。通过指定生命周期参数，表明列表中的每一个元素都至少与列表本身存在的一样久。例如，借用检查器不会允许 let a = Cons(10, &amp;Nil); 编译，因为临时值 Nil 会在 a 获取其引用之前就被丢弃了。</p> <p>相反，我们修改 List 的定义为使用 <code>Rc&lt;T&gt;</code> 代替 <code>Box&lt;T&gt;</code>，如列表 15-18 所示。现在每一个 Cons 变量都包含一个值和一个指向 List 的 Rc。当创建 b 时，不同于获取 a 的所有权，这里会克隆 a 所包含的 Rc，这会将引用计数从 1 增加到 2 并允许 a 和 b 共享 Rc 中数据的所有权。创建 c 时也会克隆 a，这会将引用计数从 2 增加为 3。每次调用 Rc::clone，Rc 中数据的引用计数都会增加，直到有零个引用之前其数据都不会被清理。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">enum</span> List <span class="token punctuation">{</span>
    <span class="token function">Cons</span><span class="token punctuation">(</span>i32<span class="token punctuation">,</span> Rc<span class="token operator">&lt;</span>List<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Nil<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">use</span> List<span class="token punctuation">::</span><span class="token punctuation">{</span>Cons<span class="token punctuation">,</span> Nil<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>rc<span class="token punctuation">::</span>Rc<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> Rc<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> Rc<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> Rc<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>Nil<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> Rc<span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> Rc<span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>需要使用 use 语句将 <code>Rc&lt;T&gt;</code> 引入作用域因为它不在 prelude 中。在 main 中创建了存放 5 和 10 的列表并将其存放在 a 的新的 <code>Rc&lt;List&gt;</code> 中。接着当创建 b 和 c 时，调用 Rc::clone 函数并传递 a 中 <code>Rc&lt;List&gt;</code> 的引用作为参数。</p> <p>也可以调用 a.clone() 而不是 Rc::clone(&amp;a)，不过在这里 Rust 的习惯是使用 Rc::clone。Rc::clone 的实现并不像大部分类型的 clone 实现那样对所有数据进行深拷贝。Rc::clone 只会增加引用计数，这并不会花费多少时间。深拷贝可能会花费很长时间。通过使用 Rc::clone 进行引用计数，可以明显的区别深拷贝类的克隆和增加引用计数类的克隆。当查找代码中的性能问题时，只需考虑深拷贝类的克隆而无需考虑 Rc::clone 调用。</p> <h2 id="引用计数"><a href="#引用计数" class="header-anchor">#</a> 引用计数</h2> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">enum</span> List <span class="token punctuation">{</span>
    <span class="token function">Cons</span><span class="token punctuation">(</span>i32<span class="token punctuation">,</span> Rc<span class="token operator">&lt;</span>List<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Nil<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">use</span> List<span class="token punctuation">::</span><span class="token punctuation">{</span>Cons<span class="token punctuation">,</span> Nil<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>rc<span class="token punctuation">::</span>Rc<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> Rc<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> Rc<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> Rc<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>Nil<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;count after creating a = {}&quot;</span><span class="token punctuation">,</span> Rc<span class="token punctuation">::</span><span class="token function">strong_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> Rc<span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;count after creating b = {}&quot;</span><span class="token punctuation">,</span> Rc<span class="token punctuation">::</span><span class="token function">strong_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> Rc<span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;count after creating c = {}&quot;</span><span class="token punctuation">,</span> Rc<span class="token punctuation">::</span><span class="token function">strong_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;count after c goes out of scope = {}&quot;</span><span class="token punctuation">,</span> Rc<span class="token punctuation">::</span><span class="token function">strong_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>通过调用 <code>Rc::strong_count</code> 函数可以获得引用计数。这个函数叫做 <code>strong_count</code> 而不是 <code>count</code> 是因为 <code>Rc&lt;T&gt;</code> 也有 <code>weak_count</code>（ 在 “避免引用循环” 部分会讲解 <code>weak_count</code> 的用途 ）</p> <p>代码输出结果：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>count after creating a <span class="token operator">=</span> <span class="token number">1</span>
count after creating b <span class="token operator">=</span> <span class="token number">2</span>
count after creating c <span class="token operator">=</span> <span class="token number">3</span>
count after c goes out of scope <span class="token operator">=</span> <span class="token number">2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>a 中 <code>Rc&lt;List&gt;</code> 的初始引用计数为 1，每次调用 <code>clone</code> 计数加 1，当 c 离开作用域时，计数减 1（ 由 <code>Drop</code> 特质实现当 <code>Rc&lt;T&gt;</code> 值离开作用域时自动减少引用计数 ），在 <code>main</code> 的结尾，当 <code>b</code> 、 <code>a</code> 离开作用域时，计数变为 0，同时 <code>Rc</code> 被完全清理。使用 <code>Rc</code> 允许一个值有多个所有者，引用计数则确保只要还存在所有者其值也将保持有效。</p> <p><code>Rc&lt;T&gt;</code> 允许通过不可变引用来只读的在程序的多个部分共享数据。如果 <code>Rc&lt;T&gt;</code> 也允许多个可变引用，则会违反下面的借用规则之一：</p> <blockquote><p>相同位置的多个可变借用可能造成数据竞争和不一致</p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/smart-pointer/drop-trait.html" class="prev">利用 Drop 特质进行清理</a></span> <span class="next"><a href="/smart-pointer/refcell.html">@ 内部可变性模式</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7819f68a.js" defer></script><script src="/assets/js/2.c7e95d31.js" defer></script><script src="/assets/js/52.2ec659fc.js" defer></script>
  </body>
</html>
