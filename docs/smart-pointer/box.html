<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用 Box&lt;T&gt; 在堆上存储数据 | Rust 学习笔记</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.8bcf7c97.css" as="style"><link rel="preload" href="/assets/js/app.7819f68a.js" as="script"><link rel="preload" href="/assets/js/2.c7e95d31.js" as="script"><link rel="preload" href="/assets/js/48.ec6ca506.js" as="script"><link rel="prefetch" href="/assets/js/10.71b7f3db.js"><link rel="prefetch" href="/assets/js/11.33bb0966.js"><link rel="prefetch" href="/assets/js/12.f7bdb846.js"><link rel="prefetch" href="/assets/js/13.14713a71.js"><link rel="prefetch" href="/assets/js/14.7a72f426.js"><link rel="prefetch" href="/assets/js/15.79443f0e.js"><link rel="prefetch" href="/assets/js/16.bfb56dec.js"><link rel="prefetch" href="/assets/js/17.c67e5630.js"><link rel="prefetch" href="/assets/js/18.28df6e14.js"><link rel="prefetch" href="/assets/js/19.6dba0f6e.js"><link rel="prefetch" href="/assets/js/20.7fe96ebb.js"><link rel="prefetch" href="/assets/js/21.c1ca2b28.js"><link rel="prefetch" href="/assets/js/22.8d30fb36.js"><link rel="prefetch" href="/assets/js/23.a04d06e6.js"><link rel="prefetch" href="/assets/js/24.8f9dbc43.js"><link rel="prefetch" href="/assets/js/25.1ab69d7f.js"><link rel="prefetch" href="/assets/js/26.9892c271.js"><link rel="prefetch" href="/assets/js/27.e2eb50d5.js"><link rel="prefetch" href="/assets/js/28.31270cab.js"><link rel="prefetch" href="/assets/js/29.e5fde72d.js"><link rel="prefetch" href="/assets/js/3.065ccf56.js"><link rel="prefetch" href="/assets/js/30.80a32322.js"><link rel="prefetch" href="/assets/js/31.827d06ec.js"><link rel="prefetch" href="/assets/js/32.b74942dc.js"><link rel="prefetch" href="/assets/js/33.db15a8db.js"><link rel="prefetch" href="/assets/js/34.343562c8.js"><link rel="prefetch" href="/assets/js/35.c33e3c9f.js"><link rel="prefetch" href="/assets/js/36.61e40180.js"><link rel="prefetch" href="/assets/js/37.907cc52e.js"><link rel="prefetch" href="/assets/js/38.87af5dd2.js"><link rel="prefetch" href="/assets/js/39.4ee57d9f.js"><link rel="prefetch" href="/assets/js/4.4b7d39e7.js"><link rel="prefetch" href="/assets/js/40.8d7408e4.js"><link rel="prefetch" href="/assets/js/41.c2046a9f.js"><link rel="prefetch" href="/assets/js/42.6cc376da.js"><link rel="prefetch" href="/assets/js/43.63a455c5.js"><link rel="prefetch" href="/assets/js/44.0d15d778.js"><link rel="prefetch" href="/assets/js/45.9be4bc9f.js"><link rel="prefetch" href="/assets/js/46.e22e8db9.js"><link rel="prefetch" href="/assets/js/47.dbd72152.js"><link rel="prefetch" href="/assets/js/49.22c5f8ae.js"><link rel="prefetch" href="/assets/js/5.3befbe85.js"><link rel="prefetch" href="/assets/js/50.4a58f660.js"><link rel="prefetch" href="/assets/js/51.36d42e96.js"><link rel="prefetch" href="/assets/js/52.2ec659fc.js"><link rel="prefetch" href="/assets/js/53.541947fb.js"><link rel="prefetch" href="/assets/js/54.1cf56973.js"><link rel="prefetch" href="/assets/js/55.27ed2009.js"><link rel="prefetch" href="/assets/js/56.4011a578.js"><link rel="prefetch" href="/assets/js/57.70babd7b.js"><link rel="prefetch" href="/assets/js/58.39568e0b.js"><link rel="prefetch" href="/assets/js/59.98811df6.js"><link rel="prefetch" href="/assets/js/6.fa4dd12d.js"><link rel="prefetch" href="/assets/js/60.c0a0c3f8.js"><link rel="prefetch" href="/assets/js/61.83913c6f.js"><link rel="prefetch" href="/assets/js/62.0ea87c47.js"><link rel="prefetch" href="/assets/js/7.e902d7c9.js"><link rel="prefetch" href="/assets/js/8.ac97398c.js"><link rel="prefetch" href="/assets/js/9.52c69a98.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8bcf7c97.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar"><!----> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">Rust Note</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目管理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>通用编程概念</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/variable.html" class="sidebar-link">变量与可变性</a></li><li><a href="/data-type.html" class="sidebar-link">数据类型</a></li><li><a href="/struct.html" class="sidebar-link">结构体</a></li><li><a href="/enumeration.html" class="sidebar-link">枚举</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/collections/" class="sidebar-heading clickable"><span>集合</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/smart-pointer/" class="sidebar-heading clickable router-link-active open"><span>智能指针</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/smart-pointer/box.html" class="active sidebar-link">使用 Box&lt;T&gt; 在堆上存储数据</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/smart-pointer/box.html#在堆上储存数据" class="sidebar-link">在堆上储存数据</a></li><li class="sidebar-sub-header"><a href="/smart-pointer/box.html#创建递归类型" class="sidebar-link">创建递归类型</a></li></ul></li><li><a href="/smart-pointer/deref-trait.html" class="sidebar-link">利用 Deref 特质进行常规引用操作</a></li><li><a href="/smart-pointer/drop-trait.html" class="sidebar-link">利用 Drop 特质进行清理</a></li><li><a href="/smart-pointer/rc.html" class="sidebar-link">引用计数智能指针 Rc&lt;T&gt;</a></li><li><a href="/smart-pointer/refcell.html" class="sidebar-link">@ 内部可变性模式</a></li><li><a href="/smart-pointer/reference-cycles-and-memory-leak.html" class="sidebar-link">@ 引用循环与内存泄漏</a></li></ul></section></li><li><a href="/function.html" class="sidebar-link">函数</a></li><li><a href="/control-flow.html" class="sidebar-link">流程控制</a></li><li><a href="/error-handling.html" class="sidebar-link">错误处理</a></li><li><a href="/comment.html" class="sidebar-link">注释</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>所有权</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>抽象</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>生命周期</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>并发编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>测试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>模式匹配</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程范式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>高级特性</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="使用-box-t-在堆上存储数据"><a href="#使用-box-t-在堆上存储数据" class="header-anchor">#</a> 使用 <code>Box&lt;T&gt;</code> 在堆上存储数据</h1> <p><code>Box&lt;T&gt;</code> 是最简单的智能指针类型，它允许将值放在堆上（ 留在栈上的则是指向堆数据的指针 ），除了提供间接存储和堆分配，并无其他额外的特殊功能，也没有这些功能带来的性能损失。</p> <p><code>Box&lt;T&gt;</code> 实现了 <code>Deref</code>、<code>Drop</code> 特质，其值可被当作引用对待，当值离开作用域时，<code>Box&lt;T&gt;</code> 实例指向的堆数据将被清除。</p> <p><code>Box&lt;T&gt;</code> 多用于以下场景：</p> <ul><li>在需要知道类型确切大小的上下文中使用一个编译时无法确定大小的类型（ 比如可以基于 <code>Box&lt;T&gt;</code> 提供的间接存储功能，实现编译时大小确定的递归类型 ）</li> <li>在不使用复制的情况下转移大量数据的所有权（ 只有少量指针数据在栈上被复制，避免栈上复制大量数据产生不必要的性能损耗 ）</li> <li>希望拥有一个实现了特定特质的任意类型的值（ 参阅 “面向对象特性” 部分中的 “为使用不同类型的值而设计的特质对象” 章节 ）</li></ul> <h2 id="在堆上储存数据"><a href="#在堆上储存数据" class="header-anchor">#</a> 在堆上储存数据</h2> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> b <span class="token operator">=</span> Box<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在堆上储存一个 i32 值</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;b = {}&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 像访问栈数据一样访问堆数据，正如拥有数据所有权的值那样</span>
<span class="token punctuation">}</span> <span class="token comment">// b 离开作用域并被释放（ 位于栈上 ），b 所指向的数据（ 位于堆上 ）也同时被释放</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>将一个单独的值存储在堆上的意义不大，通常是将其储存在栈上，但有些类型在不使用 <code>Box&lt;T&gt;</code> 的情况下无法定义，比如递归类型。</p> <h2 id="创建递归类型"><a href="#创建递归类型" class="header-anchor">#</a> 创建递归类型</h2> <p>Rust 需要在编译时知道类型占用多少空间，而递归类型（ recursive type ）无法在编译时知道确切大小。通过在递归类型定义中插入 <code>Box&lt;T&gt;</code>，可以在 Rust 中创建递归类型。</p> <h3 id="非递归类型的大小"><a href="#非递归类型的大小" class="header-anchor">#</a> 非递归类型的大小</h3> <p>枚举类型 <code>Message</code> 值的大小等于存储其最大成员的所需的空间大小</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">enum</span> Message <span class="token punctuation">{</span>
    Quit<span class="token punctuation">,</span> <span class="token comment">// 不需要任何空间</span>
    Move <span class="token punctuation">{</span> x<span class="token punctuation">:</span> i32<span class="token punctuation">,</span> y<span class="token punctuation">:</span> i32 <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 需要足够储存两个 i32 值的空间</span>
    <span class="token function">Write</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">ChangeColor</span><span class="token punctuation">(</span>i32<span class="token punctuation">,</span> i32<span class="token punctuation">,</span> i32<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="编译时无确切大小的递归类型"><a href="#编译时无确切大小的递归类型" class="header-anchor">#</a> 编译时无确切大小的递归类型</h3> <p><code>cons list</code> 是一个源于 Lisp 编程语言的数据结构，其每一项都包含两个元素：当前项的值、下一项。其最后一项的值仅包含一个叫做 <code>Nil</code> 的值，没有下一项。</p> <p>在 <code>Lisp</code> 语言中，<code>cons</code> 函数以一个值和一个列表作为参数生成一个新的列表。</p> <p><code>cons list</code> 通过递归调用 <code>cons</code> 函数产生，遇到 <code>Nil</code> 值时递归结束，表示列表终止。</p> <p><code>cons list</code> 并非 Rust 中常见的类型，在 Rust 中创建列表的时候，<code>Vec&lt;T&gt;</code> 通常是一个更好的选择。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// 利用泛型，以下数据结构可以存放任何类型值</span>
<span class="token keyword">enum</span> List <span class="token punctuation">{</span>
    <span class="token function">Cons</span><span class="token punctuation">(</span>i32<span class="token punctuation">,</span> List<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Nil<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> List<span class="token punctuation">::</span><span class="token punctuation">{</span>Cons<span class="token punctuation">,</span> Nil<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> Nil<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>编译以上代码会得到错误：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code>error<span class="token punctuation">[</span>E0072<span class="token punctuation">]</span><span class="token punctuation">:</span> recursive <span class="token keyword">type</span> `List` has infinite size
 <span class="token operator">-</span><span class="token punctuation">-&gt;</span> src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">1</span>
  <span class="token operator">|</span>
<span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">enum</span> List <span class="token punctuation">{</span>
  <span class="token operator">|</span> <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> recursive <span class="token keyword">type</span> has infinite size
<span class="token number">2</span> <span class="token operator">|</span>     <span class="token function">Cons</span><span class="token punctuation">(</span>i32<span class="token punctuation">,</span> List<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token operator">|</span>               <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> recursive without indirection
  <span class="token operator">|</span>
  <span class="token operator">=</span> help<span class="token punctuation">:</span> insert <span class="token function">indirection</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span><span class="token punctuation">,</span> a `Box`<span class="token punctuation">,</span> `Rc`<span class="token punctuation">,</span> or `<span class="token operator">&amp;</span>`<span class="token punctuation">)</span> at some point to
  make `List` representable
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>错误信息表明 <code>List</code> 类型 “有无限的大小”，原因在于 <code>List</code> 的成员被定义为是递归的，当 Rust 编译器尝试计算出储存一个 <code>List</code> 枚举需要多少内存，会检查 <code>Cons</code> 成员，<code>Cons</code> 需要的空间等于 <code>i32</code> 的大小加上 <code>List</code> 的大小。为了计算 <code>List</code> 需要多少内存，编译器检查其成员，从 <code>Cons</code> 成员开始。<code>Cons</code> 成员储存了一个 <code>i32</code> 值和一个 <code>List</code> 值，计算将无限进行下去。这意味着 Rust 无法计算为了存放 <code>List</code> 的值到底需要多少空间。</p> <p>编译信息也包含了建议， “indirection” 表明相比直接储存一个值应当间接的储存一个指向值的指针。</p> <h3 id="创建编译时具有确切大小的递归类型"><a href="#创建编译时具有确切大小的递归类型" class="header-anchor">#</a> 创建编译时具有确切大小的递归类型</h3> <p><code>Box&lt;T&gt;</code> 是一个指针，其存储空间大小固定，不会随着其指向的堆数据量改变。因此可将 <code>Box</code> 作为 <code>Cons</code> 的下一项，<code>Box</code> 指向另一个位于堆上的 <code>List</code> 值（ 而不是存放在 <code>Cons</code> 成员中，<code>Cons</code> 成员所需空间也更少 ）。这种实现列表的方式更像是一个项挨着另一项，而不是一项包含另一项。</p> <p>现在，编译器能够计算出 <code>List</code> 类型的大小 - <strong>最多需一个 <code>i32</code> 的大小加上 <code>Box</code> 指针数据的大小</strong></p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">enum</span> List <span class="token punctuation">{</span>
    <span class="token function">Cons</span><span class="token punctuation">(</span>i32<span class="token punctuation">,</span> Box<span class="token operator">&lt;</span>List<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Nil<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">use</span> List<span class="token punctuation">::</span><span class="token punctuation">{</span>Cons<span class="token punctuation">,</span> Nil<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>
        Box<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>
            Box<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>
                Box<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>Nil<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/collections/hashmap.html" class="prev">散列表</a></span> <span class="next"><a href="/smart-pointer/deref-trait.html">利用 Deref 特质进行常规引用操作</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7819f68a.js" defer></script><script src="/assets/js/2.c7e95d31.js" defer></script><script src="/assets/js/48.ec6ca506.js" defer></script>
  </body>
</html>
