<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>利用 Drop 特质进行清理 | Rust 学习笔记</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.8bcf7c97.css" as="style"><link rel="preload" href="/assets/js/app.7819f68a.js" as="script"><link rel="preload" href="/assets/js/2.c7e95d31.js" as="script"><link rel="preload" href="/assets/js/50.4a58f660.js" as="script"><link rel="prefetch" href="/assets/js/10.71b7f3db.js"><link rel="prefetch" href="/assets/js/11.33bb0966.js"><link rel="prefetch" href="/assets/js/12.f7bdb846.js"><link rel="prefetch" href="/assets/js/13.14713a71.js"><link rel="prefetch" href="/assets/js/14.7a72f426.js"><link rel="prefetch" href="/assets/js/15.79443f0e.js"><link rel="prefetch" href="/assets/js/16.bfb56dec.js"><link rel="prefetch" href="/assets/js/17.c67e5630.js"><link rel="prefetch" href="/assets/js/18.28df6e14.js"><link rel="prefetch" href="/assets/js/19.6dba0f6e.js"><link rel="prefetch" href="/assets/js/20.7fe96ebb.js"><link rel="prefetch" href="/assets/js/21.c1ca2b28.js"><link rel="prefetch" href="/assets/js/22.8d30fb36.js"><link rel="prefetch" href="/assets/js/23.a04d06e6.js"><link rel="prefetch" href="/assets/js/24.8f9dbc43.js"><link rel="prefetch" href="/assets/js/25.1ab69d7f.js"><link rel="prefetch" href="/assets/js/26.9892c271.js"><link rel="prefetch" href="/assets/js/27.e2eb50d5.js"><link rel="prefetch" href="/assets/js/28.31270cab.js"><link rel="prefetch" href="/assets/js/29.e5fde72d.js"><link rel="prefetch" href="/assets/js/3.065ccf56.js"><link rel="prefetch" href="/assets/js/30.80a32322.js"><link rel="prefetch" href="/assets/js/31.827d06ec.js"><link rel="prefetch" href="/assets/js/32.b74942dc.js"><link rel="prefetch" href="/assets/js/33.db15a8db.js"><link rel="prefetch" href="/assets/js/34.343562c8.js"><link rel="prefetch" href="/assets/js/35.c33e3c9f.js"><link rel="prefetch" href="/assets/js/36.61e40180.js"><link rel="prefetch" href="/assets/js/37.907cc52e.js"><link rel="prefetch" href="/assets/js/38.87af5dd2.js"><link rel="prefetch" href="/assets/js/39.4ee57d9f.js"><link rel="prefetch" href="/assets/js/4.4b7d39e7.js"><link rel="prefetch" href="/assets/js/40.8d7408e4.js"><link rel="prefetch" href="/assets/js/41.c2046a9f.js"><link rel="prefetch" href="/assets/js/42.6cc376da.js"><link rel="prefetch" href="/assets/js/43.63a455c5.js"><link rel="prefetch" href="/assets/js/44.0d15d778.js"><link rel="prefetch" href="/assets/js/45.9be4bc9f.js"><link rel="prefetch" href="/assets/js/46.e22e8db9.js"><link rel="prefetch" href="/assets/js/47.dbd72152.js"><link rel="prefetch" href="/assets/js/48.ec6ca506.js"><link rel="prefetch" href="/assets/js/49.22c5f8ae.js"><link rel="prefetch" href="/assets/js/5.3befbe85.js"><link rel="prefetch" href="/assets/js/51.36d42e96.js"><link rel="prefetch" href="/assets/js/52.2ec659fc.js"><link rel="prefetch" href="/assets/js/53.541947fb.js"><link rel="prefetch" href="/assets/js/54.1cf56973.js"><link rel="prefetch" href="/assets/js/55.27ed2009.js"><link rel="prefetch" href="/assets/js/56.4011a578.js"><link rel="prefetch" href="/assets/js/57.70babd7b.js"><link rel="prefetch" href="/assets/js/58.39568e0b.js"><link rel="prefetch" href="/assets/js/59.98811df6.js"><link rel="prefetch" href="/assets/js/6.fa4dd12d.js"><link rel="prefetch" href="/assets/js/60.c0a0c3f8.js"><link rel="prefetch" href="/assets/js/61.83913c6f.js"><link rel="prefetch" href="/assets/js/62.0ea87c47.js"><link rel="prefetch" href="/assets/js/7.e902d7c9.js"><link rel="prefetch" href="/assets/js/8.ac97398c.js"><link rel="prefetch" href="/assets/js/9.52c69a98.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8bcf7c97.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar"><!----> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">Rust Note</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目管理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>通用编程概念</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/variable.html" class="sidebar-link">变量与可变性</a></li><li><a href="/data-type.html" class="sidebar-link">数据类型</a></li><li><a href="/struct.html" class="sidebar-link">结构体</a></li><li><a href="/enumeration.html" class="sidebar-link">枚举</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/collections/" class="sidebar-heading clickable"><span>集合</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/smart-pointer/" class="sidebar-heading clickable router-link-active open"><span>智能指针</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/smart-pointer/box.html" class="sidebar-link">使用 Box&lt;T&gt; 在堆上存储数据</a></li><li><a href="/smart-pointer/deref-trait.html" class="sidebar-link">利用 Deref 特质进行常规引用操作</a></li><li><a href="/smart-pointer/drop-trait.html" class="active sidebar-link">利用 Drop 特质进行清理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/smart-pointer/drop-trait.html#自动清理" class="sidebar-link">自动清理</a></li><li class="sidebar-sub-header"><a href="/smart-pointer/drop-trait.html#提前主动清理" class="sidebar-link">提前主动清理</a></li></ul></li><li><a href="/smart-pointer/rc.html" class="sidebar-link">引用计数智能指针 Rc&lt;T&gt;</a></li><li><a href="/smart-pointer/refcell.html" class="sidebar-link">@ 内部可变性模式</a></li><li><a href="/smart-pointer/reference-cycles-and-memory-leak.html" class="sidebar-link">@ 引用循环与内存泄漏</a></li></ul></section></li><li><a href="/function.html" class="sidebar-link">函数</a></li><li><a href="/control-flow.html" class="sidebar-link">流程控制</a></li><li><a href="/error-handling.html" class="sidebar-link">错误处理</a></li><li><a href="/comment.html" class="sidebar-link">注释</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>所有权</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>抽象</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>生命周期</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>并发编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>测试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>模式匹配</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程范式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>高级特性</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="利用-drop-特质进行清理"><a href="#利用-drop-特质进行清理" class="header-anchor">#</a> 利用 <code>Drop</code> 特质进行清理</h1> <p>其他语言需在每次使用完智能指针实例后调用清理内存或资源的代码，忘记的话可能导致系统崩溃。</p> <p>在 Rust 中，通过指定在值离开作用域时需要被执行的代码（ 以实现 <code>Drop</code> 特质的方式 ），编译器将自动插入并且执行这些代码，无需在程序中编写用于实例结束时清理的代码，并且不会泄露资源。</p> <p>可以为任何类型提供 <code>Drop</code> 特质的实现，用于释放资源。不过 <code>Drop</code> 特质更常用于实现智能指针。例如 <code>Box&lt;T&gt;</code> 自定义了 <code>Drop</code> 用来释放 box 所指向的堆空间。</p> <h2 id="自动清理"><a href="#自动清理" class="header-anchor">#</a> 自动清理</h2> <ul><li><code>Drop</code> 特质包含在 <code>prelude</code> 中，无需导入</li> <li><code>Drop</code> 特质要求实现 <code>drop</code> 方法，用于执行当类型实例离开作用域时需要运行的逻辑</li> <li>当实例离开作用域时，其 <code>drop</code> 方法自动调用，以与创建顺序相反的顺序被丢弃（ d 在 c 之前 ）</li></ul> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">struct</span> CustomSmartPointer <span class="token punctuation">{</span>
    data<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Drop <span class="token keyword">for</span> CustomSmartPointer <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">drop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Dropping CustomSmartPointer with data `{}`!&quot;</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> c <span class="token operator">=</span> CustomSmartPointer <span class="token punctuation">{</span> data<span class="token punctuation">:</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;my stuff&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> d <span class="token operator">=</span> CustomSmartPointer <span class="token punctuation">{</span> data<span class="token punctuation">:</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;other stuff&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;CustomSmartPointers created.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>运行程序输出：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>CustomSmartPointers created.
Dropping CustomSmartPointer with data <span class="token variable"><span class="token variable">`</span>other stuff<span class="token variable">`</span></span><span class="token operator">!</span>
Dropping CustomSmartPointer with data <span class="token variable"><span class="token variable">`</span>my stuff<span class="token variable">`</span></span><span class="token operator">!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="提前主动清理"><a href="#提前主动清理" class="header-anchor">#</a> 提前主动清理</h2> <p><code>Drop</code> 特质的意义在于自动处理。然而有时可能需要提前清理某个值（ 而不是等到值离开作用域时由 Rust 调用 <code>drop</code> 方法进行自动清理 ），比如使用智能指针管理锁时，可能希望强制运行 <code>drop</code> 方法来释放锁以便作用域中的其他代码可以获取锁。</p> <p>但是，Rust 并不允许主动调用 <code>Drop</code> 特质的 <code>drop</code> 方法：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> c <span class="token operator">=</span> CustomSmartPointer <span class="token punctuation">{</span> data<span class="token punctuation">:</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;some data&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;CustomSmartPointer created.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    c<span class="token punctuation">.</span><span class="token function">drop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;CustomSmartPointer dropped before the end of main.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>会得到编译错误：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>error<span class="token punctuation">[</span>E0040<span class="token punctuation">]</span>: explicit use of destructor method
  --<span class="token operator">&gt;</span> src/main.rs:14:7
   <span class="token operator">|</span>
<span class="token number">14</span> <span class="token operator">|</span>     c.drop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token operator">|</span>       ^^^^ explicit destructor calls not allowed
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>错误信息表明 Rust 不允许显式调用 <code>drop</code> 方法（ 同时也指出了 <code>drop</code> 是一个析构函数 ），这是因为 Rust 会在 <code>main</code> 方法结尾对值自动调用 <code>drop</code> 方法，这将导致双重释放错误（ 清理相同的值两次 ）, 并且，自动插入的 <code>drop</code> 功能是无法禁用的（ 通常也不需要禁用 ）。</p> <h3 id="使用-std-mem-drop-在作用域结束之前强制释放变量"><a href="#使用-std-mem-drop-在作用域结束之前强制释放变量" class="header-anchor">#</a> 使用 <code>std::mem::drop</code> 在作用域结束之前强制释放变量</h3> <p>该函数包含于 <code>prelude</code>，无需导入</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">struct</span> CustomSmartPointer <span class="token punctuation">{</span>
    data<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Drop <span class="token keyword">for</span> CustomSmartPointer <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">drop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Dropping CustomSmartPointer with data `{}`!&quot;</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> c <span class="token operator">=</span> CustomSmartPointer <span class="token punctuation">{</span> data<span class="token punctuation">:</span> String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;some data&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;CustomSmartPointer created.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">drop</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;CustomSmartPointer dropped before the end of main.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>运行后输出：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>CustomSmartPointer created.
Dropping CustomSmartPointer with data <span class="token variable"><span class="token variable">`</span>some data<span class="token variable">`</span></span><span class="token operator">!</span>
CustomSmartPointer dropped before the end of main.
Dropping CustomSmartPointer with data <span class="token variable"><span class="token variable">`</span>some data<span class="token variable">`</span></span><span class="token operator">!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>第2行输出表明 drop 方法被调用并在此丢弃了 c</p> <p>通过实现 <code>Drop</code> 特质使清理操作变得方便和安全，这非常有用，比如可以用来创建我们自己的内存分配器，通过 <code>Drop</code> 特质和 Rust 所有权系统，无需担心之后清理代码，Rust 会自动考虑这些问题。</p> <p>我们也无需担心意外清理掉仍在使用的值（ 引发编译时错误 ），所有权系统会确保引用总是有效以及 <code>drop</code> 方法只会在值不再被使用时被调用一次。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/smart-pointer/deref-trait.html" class="prev">利用 Deref 特质进行常规引用操作</a></span> <span class="next"><a href="/smart-pointer/rc.html">引用计数智能指针 Rc&lt;T&gt;</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7819f68a.js" defer></script><script src="/assets/js/2.c7e95d31.js" defer></script><script src="/assets/js/50.4a58f660.js" defer></script>
  </body>
</html>
