<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>创建线程 | Rust 学习笔记</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.8bcf7c97.css" as="style"><link rel="preload" href="/assets/js/app.7819f68a.js" as="script"><link rel="preload" href="/assets/js/2.c7e95d31.js" as="script"><link rel="preload" href="/assets/js/20.7fe96ebb.js" as="script"><link rel="prefetch" href="/assets/js/10.71b7f3db.js"><link rel="prefetch" href="/assets/js/11.33bb0966.js"><link rel="prefetch" href="/assets/js/12.f7bdb846.js"><link rel="prefetch" href="/assets/js/13.14713a71.js"><link rel="prefetch" href="/assets/js/14.7a72f426.js"><link rel="prefetch" href="/assets/js/15.79443f0e.js"><link rel="prefetch" href="/assets/js/16.bfb56dec.js"><link rel="prefetch" href="/assets/js/17.c67e5630.js"><link rel="prefetch" href="/assets/js/18.28df6e14.js"><link rel="prefetch" href="/assets/js/19.6dba0f6e.js"><link rel="prefetch" href="/assets/js/21.c1ca2b28.js"><link rel="prefetch" href="/assets/js/22.8d30fb36.js"><link rel="prefetch" href="/assets/js/23.a04d06e6.js"><link rel="prefetch" href="/assets/js/24.8f9dbc43.js"><link rel="prefetch" href="/assets/js/25.1ab69d7f.js"><link rel="prefetch" href="/assets/js/26.9892c271.js"><link rel="prefetch" href="/assets/js/27.e2eb50d5.js"><link rel="prefetch" href="/assets/js/28.31270cab.js"><link rel="prefetch" href="/assets/js/29.e5fde72d.js"><link rel="prefetch" href="/assets/js/3.065ccf56.js"><link rel="prefetch" href="/assets/js/30.80a32322.js"><link rel="prefetch" href="/assets/js/31.827d06ec.js"><link rel="prefetch" href="/assets/js/32.b74942dc.js"><link rel="prefetch" href="/assets/js/33.db15a8db.js"><link rel="prefetch" href="/assets/js/34.343562c8.js"><link rel="prefetch" href="/assets/js/35.c33e3c9f.js"><link rel="prefetch" href="/assets/js/36.61e40180.js"><link rel="prefetch" href="/assets/js/37.907cc52e.js"><link rel="prefetch" href="/assets/js/38.87af5dd2.js"><link rel="prefetch" href="/assets/js/39.4ee57d9f.js"><link rel="prefetch" href="/assets/js/4.4b7d39e7.js"><link rel="prefetch" href="/assets/js/40.8d7408e4.js"><link rel="prefetch" href="/assets/js/41.c2046a9f.js"><link rel="prefetch" href="/assets/js/42.6cc376da.js"><link rel="prefetch" href="/assets/js/43.63a455c5.js"><link rel="prefetch" href="/assets/js/44.0d15d778.js"><link rel="prefetch" href="/assets/js/45.9be4bc9f.js"><link rel="prefetch" href="/assets/js/46.e22e8db9.js"><link rel="prefetch" href="/assets/js/47.dbd72152.js"><link rel="prefetch" href="/assets/js/48.ec6ca506.js"><link rel="prefetch" href="/assets/js/49.22c5f8ae.js"><link rel="prefetch" href="/assets/js/5.3befbe85.js"><link rel="prefetch" href="/assets/js/50.4a58f660.js"><link rel="prefetch" href="/assets/js/51.36d42e96.js"><link rel="prefetch" href="/assets/js/52.2ec659fc.js"><link rel="prefetch" href="/assets/js/53.541947fb.js"><link rel="prefetch" href="/assets/js/54.1cf56973.js"><link rel="prefetch" href="/assets/js/55.27ed2009.js"><link rel="prefetch" href="/assets/js/56.4011a578.js"><link rel="prefetch" href="/assets/js/57.70babd7b.js"><link rel="prefetch" href="/assets/js/58.39568e0b.js"><link rel="prefetch" href="/assets/js/59.98811df6.js"><link rel="prefetch" href="/assets/js/6.fa4dd12d.js"><link rel="prefetch" href="/assets/js/60.c0a0c3f8.js"><link rel="prefetch" href="/assets/js/61.83913c6f.js"><link rel="prefetch" href="/assets/js/62.0ea87c47.js"><link rel="prefetch" href="/assets/js/7.e902d7c9.js"><link rel="prefetch" href="/assets/js/8.ac97398c.js"><link rel="prefetch" href="/assets/js/9.52c69a98.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8bcf7c97.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar"><!----> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">Rust Note</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目管理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>通用编程概念</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>所有权</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>抽象</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>生命周期</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>并发编程</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/concurrent/intro.html" class="sidebar-link">并发编程</a></li><li><a href="/concurrent/process-and-thread.html" class="sidebar-link">进程 vs 线程</a></li><li><a href="/concurrent/thread-models.html" class="sidebar-link">线程模型</a></li><li><a href="/concurrent/create-thread.html" class="active sidebar-link">创建线程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/concurrent/create-thread.html#使用-spawn-创建新线程" class="sidebar-link">使用 spawn 创建新线程</a></li><li class="sidebar-sub-header"><a href="/concurrent/create-thread.html#使用-move-闭包跨线程访问数据" class="sidebar-link">使用 move 闭包跨线程访问数据</a></li></ul></li><li><a href="/concurrent/communication.html" class="sidebar-link">线程通信</a></li><li><a href="/concurrent/share-state.html" class="sidebar-link">共享状态并发</a></li><li><a href="/concurrent/extensible.html" class="sidebar-link">基于特质的可扩展并发</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>测试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>模式匹配</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程范式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>高级特性</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="创建线程"><a href="#创建线程" class="header-anchor">#</a> 创建线程</h1> <h2 id="使用-spawn-创建新线程"><a href="#使用-spawn-创建新线程" class="header-anchor">#</a> 使用 <code>spawn</code> 创建新线程</h2> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>thread<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>time<span class="token punctuation">::</span>Duration<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 传递闭包</span>
    thread<span class="token punctuation">::</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span><span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span><span class="token number">10</span> <span class="token punctuation">{</span>
            <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;hi number {} from the spawned thread!&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">::</span><span class="token function">sleep</span><span class="token punctuation">(</span>Duration<span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span><span class="token number">5</span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;hi number {} from the main thread!&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">::</span><span class="token function">sleep</span><span class="token punctuation">(</span>Duration<span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>由于标准库使用 1:1 模型（ 依赖于操作系统如何调度线程 ），因此该示例：</p> <ul><li>不能保证新建线程会被执行（ 因为无法保证线程运行顺序 ）</li> <li>主线程结束时，新建线程也会提前结束（ 部分执行 ）</li> <li>无法保证新建线程先于主线程输出</li></ul> <h3 id="使用-join-等待所有线程结束"><a href="#使用-join-等待所有线程结束" class="header-anchor">#</a> 使用 <code>join</code> 等待所有线程结束</h3> <p>修复新建线程部分执行或者完全不执行的问题：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>thread<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>time<span class="token punctuation">::</span>Duration<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// thread::spawn 的返回值类型是 JoinHandle（ 一个拥有所有权的值 ）</span>
    <span class="token keyword">let</span> handle <span class="token operator">=</span> thread<span class="token punctuation">::</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span><span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span><span class="token number">10</span> <span class="token punctuation">{</span>
            <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;hi number {} from the spawned thread!&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">::</span><span class="token function">sleep</span><span class="token punctuation">(</span>Duration<span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span><span class="token number">5</span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;hi number {} from the main thread!&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">::</span><span class="token function">sleep</span><span class="token punctuation">(</span>Duration<span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 阻塞当前线程（ 主线程 ）直到 handle 代表的线程（ 新建线程 ）结束</span>
    <span class="token comment">// 确保新建线程在 main 退出前全部执行</span>
    handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>考虑移动 <code>handle.join()</code> 的位置：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>thread<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>time<span class="token punctuation">::</span>Duration<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> handle <span class="token operator">=</span> thread<span class="token punctuation">::</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span><span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span><span class="token number">10</span> <span class="token punctuation">{</span>
            <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;hi number {} from the spawned thread!&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">::</span><span class="token function">sleep</span><span class="token punctuation">(</span>Duration<span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span><span class="token number">5</span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;hi number {} from the main thread!&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">::</span><span class="token function">sleep</span><span class="token punctuation">(</span>Duration<span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>主线程会等待直到新建线程执行完毕之后才开始执行 <code>for</code> 循环，所以输出不会交替出现：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>hi number <span class="token number">1</span> from the spawned thread<span class="token operator">!</span>
hi number <span class="token number">2</span> from the spawned thread<span class="token operator">!</span>
hi number <span class="token number">3</span> from the spawned thread<span class="token operator">!</span>
hi number <span class="token number">4</span> from the spawned thread<span class="token operator">!</span>
hi number <span class="token number">5</span> from the spawned thread<span class="token operator">!</span>
hi number <span class="token number">6</span> from the spawned thread<span class="token operator">!</span>
hi number <span class="token number">7</span> from the spawned thread<span class="token operator">!</span>
hi number <span class="token number">8</span> from the spawned thread<span class="token operator">!</span>
hi number <span class="token number">9</span> from the spawned thread<span class="token operator">!</span>
hi number <span class="token number">1</span> from the main thread<span class="token operator">!</span>
hi number <span class="token number">2</span> from the main thread<span class="token operator">!</span>
hi number <span class="token number">3</span> from the main thread<span class="token operator">!</span>
hi number <span class="token number">4</span> from the main thread<span class="token operator">!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="使用-move-闭包跨线程访问数据"><a href="#使用-move-闭包跨线程访问数据" class="header-anchor">#</a> 使用 <code>move</code> 闭包跨线程访问数据</h2> <p>尝试在新建线程中使用主线程中创建的数据：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>thread<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> handle <span class="token operator">=</span> thread<span class="token punctuation">::</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span><span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Here's a vector: {:?}&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>得到错误：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>error<span class="token punctuation">[</span>E0373<span class="token punctuation">]</span>: closure may outlive the current function, but it borrows <span class="token variable"><span class="token variable">`</span><span class="token function">v</span><span class="token variable">`</span></span>,
<span class="token function">which</span> is owned by the current <span class="token keyword">function</span>
 --<span class="token operator">&gt;</span> src/main.rs:6:32
  <span class="token operator">|</span>
<span class="token number">6</span> <span class="token operator">|</span>     <span class="token builtin class-name">let</span> handle <span class="token operator">=</span> thread::spawn<span class="token punctuation">(</span><span class="token operator">||</span> <span class="token punctuation">{</span>
  <span class="token operator">|</span>                                ^^ may outlive borrowed value <span class="token variable"><span class="token variable">`</span><span class="token function">v</span><span class="token variable">`</span></span>
<span class="token number">7</span> <span class="token operator">|</span>         println<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">&quot;Here's a vector: {:?}&quot;</span>, <span class="token function">v</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">|</span>                                           - <span class="token variable"><span class="token variable">`</span><span class="token function">v</span><span class="token variable">`</span></span> is borrowed here
  <span class="token operator">|</span>
help: to force the closure to take ownership of <span class="token variable"><span class="token variable">`</span><span class="token function">v</span><span class="token variable">`</span></span> <span class="token punctuation">(</span>and any other referenced
variables<span class="token punctuation">)</span>, use the <span class="token variable"><span class="token variable">`</span>move<span class="token variable">`</span></span> keyword
  <span class="token operator">|</span>
<span class="token number">6</span> <span class="token operator">|</span>     <span class="token builtin class-name">let</span> handle <span class="token operator">=</span> thread::spawn<span class="token punctuation">(</span>move <span class="token operator">||</span> <span class="token punctuation">{</span>
  <span class="token operator">|</span>                                ^^^^^^^
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>Rust 会推断引用 <code>v</code> 的生命周期，因为 <code>println!</code> 需要 <code>v</code>，闭包会尝试借用 <code>v</code>。然而 Rust 不知道新建线程会执行多久，所以无法确认 <code>v</code> 的引用是否一直有效。</p> <p>例如，下面代码中 <code>v</code> 的引用就不再有效：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>thread<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> handle <span class="token operator">=</span> thread<span class="token punctuation">::</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span><span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用闭包的线程，尝试使用一个在主线程中被回收的引用 v</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Here's a vector: {:?}&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">drop</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// v 不再有效，此时还有线程在使用该引用的数据，产生了悬垂引用！</span>

    handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>在闭包之前增加 <code>move</code> 关键字，强制闭包获取其使用的值的所有权，而不是由 Rust 推断使用借用值。</p> <p>修正后的代码可以通过编译：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>thread<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> handle <span class="token operator">=</span> thread<span class="token punctuation">::</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token punctuation">|</span><span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Here's a vector: {:?}&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>使用 <code>move</code> 后，主线程中将不能对 <code>v</code> 调用 <code>drop</code> 方法：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>error<span class="token punctuation">[</span>E0382<span class="token punctuation">]</span>: use of moved value: <span class="token variable"><span class="token variable">`</span><span class="token function">v</span><span class="token variable">`</span></span>
  --<span class="token operator">&gt;</span> src/main.rs:10:10
   <span class="token operator">|</span>
<span class="token number">6</span>  <span class="token operator">|</span>     <span class="token builtin class-name">let</span> handle <span class="token operator">=</span> thread::spawn<span class="token punctuation">(</span>move <span class="token operator">||</span> <span class="token punctuation">{</span>
   <span class="token operator">|</span>                                ------- value moved <span class="token punctuation">(</span>into closure<span class="token punctuation">)</span> here
<span class="token punctuation">..</span>.
<span class="token number">10</span> <span class="token operator">|</span>     drop<span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span> // oh no<span class="token operator">!</span>
   <span class="token operator">|</span>          ^ value used here after move
   <span class="token operator">|</span>
   <span class="token operator">=</span> note: move occurs because <span class="token variable"><span class="token variable">`</span><span class="token function">v</span><span class="token variable">`</span></span> has <span class="token builtin class-name">type</span> <span class="token variable"><span class="token variable">`</span>std::vec::Vec<span class="token operator">&lt;</span>i3<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token variable">`</span></span>, <span class="token function">which</span> does
   not implement the <span class="token variable"><span class="token variable">`</span>Copy<span class="token variable">`</span></span> trait
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>关键字 <code>move</code> 覆盖了 Rust 默认保守的借用规定，使线程可以获取其他线程中数据的所有权，从而得以安全执行。引用仍然需要遵守所有权规则，不允许在被移动的数据所在线程中继续操作该数据。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/concurrent/thread-models.html" class="prev">线程模型</a></span> <span class="next"><a href="/concurrent/communication.html">线程通信</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7819f68a.js" defer></script><script src="/assets/js/2.c7e95d31.js" defer></script><script src="/assets/js/20.7fe96ebb.js" defer></script>
  </body>
</html>
