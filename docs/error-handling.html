<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>错误处理 | Rust 学习笔记</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.8bcf7c97.css" as="style"><link rel="preload" href="/assets/js/app.7819f68a.js" as="script"><link rel="preload" href="/assets/js/2.c7e95d31.js" as="script"><link rel="preload" href="/assets/js/29.e5fde72d.js" as="script"><link rel="prefetch" href="/assets/js/10.71b7f3db.js"><link rel="prefetch" href="/assets/js/11.33bb0966.js"><link rel="prefetch" href="/assets/js/12.f7bdb846.js"><link rel="prefetch" href="/assets/js/13.14713a71.js"><link rel="prefetch" href="/assets/js/14.7a72f426.js"><link rel="prefetch" href="/assets/js/15.79443f0e.js"><link rel="prefetch" href="/assets/js/16.bfb56dec.js"><link rel="prefetch" href="/assets/js/17.c67e5630.js"><link rel="prefetch" href="/assets/js/18.28df6e14.js"><link rel="prefetch" href="/assets/js/19.6dba0f6e.js"><link rel="prefetch" href="/assets/js/20.7fe96ebb.js"><link rel="prefetch" href="/assets/js/21.c1ca2b28.js"><link rel="prefetch" href="/assets/js/22.8d30fb36.js"><link rel="prefetch" href="/assets/js/23.a04d06e6.js"><link rel="prefetch" href="/assets/js/24.8f9dbc43.js"><link rel="prefetch" href="/assets/js/25.1ab69d7f.js"><link rel="prefetch" href="/assets/js/26.9892c271.js"><link rel="prefetch" href="/assets/js/27.e2eb50d5.js"><link rel="prefetch" href="/assets/js/28.31270cab.js"><link rel="prefetch" href="/assets/js/3.065ccf56.js"><link rel="prefetch" href="/assets/js/30.80a32322.js"><link rel="prefetch" href="/assets/js/31.827d06ec.js"><link rel="prefetch" href="/assets/js/32.b74942dc.js"><link rel="prefetch" href="/assets/js/33.db15a8db.js"><link rel="prefetch" href="/assets/js/34.343562c8.js"><link rel="prefetch" href="/assets/js/35.c33e3c9f.js"><link rel="prefetch" href="/assets/js/36.61e40180.js"><link rel="prefetch" href="/assets/js/37.907cc52e.js"><link rel="prefetch" href="/assets/js/38.87af5dd2.js"><link rel="prefetch" href="/assets/js/39.4ee57d9f.js"><link rel="prefetch" href="/assets/js/4.4b7d39e7.js"><link rel="prefetch" href="/assets/js/40.8d7408e4.js"><link rel="prefetch" href="/assets/js/41.c2046a9f.js"><link rel="prefetch" href="/assets/js/42.6cc376da.js"><link rel="prefetch" href="/assets/js/43.63a455c5.js"><link rel="prefetch" href="/assets/js/44.0d15d778.js"><link rel="prefetch" href="/assets/js/45.9be4bc9f.js"><link rel="prefetch" href="/assets/js/46.e22e8db9.js"><link rel="prefetch" href="/assets/js/47.dbd72152.js"><link rel="prefetch" href="/assets/js/48.ec6ca506.js"><link rel="prefetch" href="/assets/js/49.22c5f8ae.js"><link rel="prefetch" href="/assets/js/5.3befbe85.js"><link rel="prefetch" href="/assets/js/50.4a58f660.js"><link rel="prefetch" href="/assets/js/51.36d42e96.js"><link rel="prefetch" href="/assets/js/52.2ec659fc.js"><link rel="prefetch" href="/assets/js/53.541947fb.js"><link rel="prefetch" href="/assets/js/54.1cf56973.js"><link rel="prefetch" href="/assets/js/55.27ed2009.js"><link rel="prefetch" href="/assets/js/56.4011a578.js"><link rel="prefetch" href="/assets/js/57.70babd7b.js"><link rel="prefetch" href="/assets/js/58.39568e0b.js"><link rel="prefetch" href="/assets/js/59.98811df6.js"><link rel="prefetch" href="/assets/js/6.fa4dd12d.js"><link rel="prefetch" href="/assets/js/60.c0a0c3f8.js"><link rel="prefetch" href="/assets/js/61.83913c6f.js"><link rel="prefetch" href="/assets/js/62.0ea87c47.js"><link rel="prefetch" href="/assets/js/7.e902d7c9.js"><link rel="prefetch" href="/assets/js/8.ac97398c.js"><link rel="prefetch" href="/assets/js/9.52c69a98.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8bcf7c97.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar"><!----> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">Rust Note</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目管理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>通用编程概念</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/variable.html" class="sidebar-link">变量与可变性</a></li><li><a href="/data-type.html" class="sidebar-link">数据类型</a></li><li><a href="/struct.html" class="sidebar-link">结构体</a></li><li><a href="/enumeration.html" class="sidebar-link">枚举</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/collections/" class="sidebar-heading clickable"><span>集合</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/smart-pointer/" class="sidebar-heading clickable"><span>智能指针</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/function.html" class="sidebar-link">函数</a></li><li><a href="/control-flow.html" class="sidebar-link">流程控制</a></li><li><a href="/error-handling.html" class="active sidebar-link">错误处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/error-handling.html#处理不可恢复错误" class="sidebar-link">处理不可恢复错误</a></li><li class="sidebar-sub-header"><a href="/error-handling.html#使用-result-处理可恢复错误" class="sidebar-link">使用 Result 处理可恢复错误</a></li><li class="sidebar-sub-header"><a href="/error-handling.html#简化调用-panic" class="sidebar-link">简化调用 panic!</a></li><li class="sidebar-sub-header"><a href="/error-handling.html#错误传递" class="sidebar-link">错误传递</a></li><li class="sidebar-sub-header"><a href="/error-handling.html#返回-result-还是-panic" class="sidebar-link">@ 返回 Result 还是 panic</a></li></ul></li><li><a href="/comment.html" class="sidebar-link">注释</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>所有权</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>抽象</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>生命周期</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>并发编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>测试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>模式匹配</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程范式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>高级特性</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="错误处理"><a href="#错误处理" class="header-anchor">#</a> 错误处理</h1> <p>Rust 没有异常的概念，对于可恢复错误，有 <code>Result&lt;T, E&gt;</code> 枚举值以及 <code>panic!</code>，遇到不可恢复错误时则停止程序执行。</p> <p>Rust 包含两种错误分类：</p> <ul><li>可恢复错误</li> <li>不可恢复错误</li></ul> <h2 id="处理不可恢复错误"><a href="#处理不可恢复错误" class="header-anchor">#</a> 处理不可恢复错误</h2> <h3 id="栈展开-vs-终止"><a href="#栈展开-vs-终止" class="header-anchor">#</a> 栈展开 vs 终止</h3> <p>当程序出现 <code>panic</code> 时有两种处理模式：</p> <ul><li>展开（ unwinding ），Rust 将回溯栈并清理所有函数的数据，过程比较繁杂。</li> <li>终止（ abort ），即不清理数据直接退出程序，程序所使用的内存由操作系统清理。</li></ul> <p>如果希望优化编译后的程序大小，可通过修改 Cargo.toml 使 panic 时的行为由展开切换为终止：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>profile.release<span class="token punctuation">]</span>
panic <span class="token operator">=</span> <span class="token string">'abort'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="panic-宏"><a href="#panic-宏" class="header-anchor">#</a> <code>panic!</code> 宏</h3> <p>执行 <code>panic!</code> 宏时，程序会打印出一个错误信息，展开并清理栈数据，然后接着退出。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;crash and burn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>运行代码得到错误：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>thread <span class="token string">'main'</span> panicked at <span class="token string">'crash and burn'</span>, src/main.rs:2:4
note: Run with <span class="token variable"><span class="token variable">`</span><span class="token assign-left variable">RUST_BACKTRACE</span><span class="token operator">=</span><span class="token number">1</span><span class="token variable">`</span></span> <span class="token keyword">for</span> a backtrace.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="显示-panic-调用栈"><a href="#显示-panic-调用栈" class="header-anchor">#</a> 显示 <code>panic!</code> 调用栈</h3> <h4 id="无-backtrace"><a href="#无-backtrace" class="header-anchor">#</a> 无 <code>backtrace</code></h4> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    v<span class="token punctuation">[</span><span class="token number">99</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>运行代码得到错误：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>thread <span class="token string">'main'</span> panicked at <span class="token string">'index out of bounds: the len is 3 but the index is
99'</span>, /checkout/src/liballoc/vec.rs:1555:10
note: Run with <span class="token variable"><span class="token variable">`</span><span class="token assign-left variable">RUST_BACKTRACE</span><span class="token operator">=</span><span class="token number">1</span><span class="token variable">`</span></span> <span class="token keyword">for</span> a backtrace.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>错误信息指向标准库 <code>vec.rs</code> 文件中的代码，即真正出现 <code>panic!</code> 的位置。</p> <h4 id="使用-backtrace-输出详细的调用栈"><a href="#使用-backtrace-输出详细的调用栈" class="header-anchor">#</a> 使用 <code>backtrace</code> 输出详细的调用栈</h4> <p>需要设置 <code>RUST_BACKTRACE</code> 环境变量</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token assign-left variable">RUST_BACKTRACE</span><span class="token operator">=</span><span class="token number">1</span> cargo run
    Finished dev <span class="token punctuation">[</span>unoptimized + debuginfo<span class="token punctuation">]</span> target<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0.0</span> secs
     Running <span class="token variable"><span class="token variable">`</span>target/debug/panic<span class="token variable">`</span></span>
thread <span class="token string">'main'</span> panicked at <span class="token string">'index out of bounds: the len is 3 but the index
is 99'</span>, /checkout/src/liballoc/vec.rs:1555:10
stack backtrace:
   <span class="token number">0</span>: std::sys::imp::backtrace::tracing::imp::unwind_backtrace
             at /checkout/src/libstd/sys/unix/backtrace/tracing/gcc_s.rs:49
   <span class="token number">1</span>: std::sys_common::backtrace::_print
             at /checkout/src/libstd/sys_common/backtrace.rs:71
   <span class="token number">2</span>: std::panicking::default_hook::<span class="token punctuation">{</span><span class="token punctuation">{</span>closure<span class="token punctuation">}</span><span class="token punctuation">}</span>
             at /checkout/src/libstd/sys_common/backtrace.rs:60
             at /checkout/src/libstd/panicking.rs:381
   <span class="token number">3</span>: std::panicking::default_hook
             at /checkout/src/libstd/panicking.rs:397
   <span class="token number">4</span>: std::panicking::rust_panic_with_hook
             at /checkout/src/libstd/panicking.rs:611
   <span class="token number">5</span>: std::panicking::begin_panic
             at /checkout/src/libstd/panicking.rs:572
   <span class="token number">6</span>: std::panicking::begin_panic_fmt
             at /checkout/src/libstd/panicking.rs:522
   <span class="token number">7</span>: rust_begin_unwind
             at /checkout/src/libstd/panicking.rs:498
   <span class="token number">8</span>: core::panicking::panic_fmt
             at /checkout/src/libcore/panicking.rs:71
   <span class="token number">9</span>: core::panicking::panic_bounds_check
             at /checkout/src/libcore/panicking.rs:58
  <span class="token number">10</span>: <span class="token operator">&lt;</span>alloc::vec::Vec<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> as core::ops::index::Index<span class="token operator">&lt;</span>usize<span class="token operator">&gt;&gt;</span>::index
             at /checkout/src/liballoc/vec.rs:1555
  <span class="token number">11</span>: panic::main
             at src/main.rs:4
  <span class="token number">12</span>: __rust_maybe_catch_panic
             at /checkout/src/libpanic_unwind/lib.rs:99
  <span class="token number">13</span>: std::rt::lang_start
             at /checkout/src/libstd/panicking.rs:459
             at /checkout/src/libstd/panic.rs:361
             at /checkout/src/libstd/rt.rs:61
  <span class="token number">14</span>: main
  <span class="token number">15</span>: __libc_start_main
  <span class="token number">16</span>: <span class="token operator">&lt;</span>unknown<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>必须启用 <code>debug</code> 标识才能获取带有详细调用栈信息的 backtrace，当不使用 <code>--release</code> 参数运行 <code>cargo build</code> 或 <code>cargo run</code> 时会默认启用 <code>debug</code> 标识。</p> <h2 id="使用-result-处理可恢复错误"><a href="#使用-result-处理可恢复错误" class="header-anchor">#</a> 使用 <code>Result</code> 处理可恢复错误</h2> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">enum</span> Result<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> E<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">Ok</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">Err</span><span class="token punctuation">(</span>E<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">use</span> std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span>File<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> f <span class="token operator">=</span> File<span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;hello.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> f <span class="token operator">=</span> <span class="token keyword">match</span> f <span class="token punctuation">{</span>
        <span class="token function">Ok</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> file<span class="token punctuation">,</span>
        <span class="token function">Err</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;There was a problem opening the file: {:?}&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="错误分类处理"><a href="#错误分类处理" class="header-anchor">#</a> 错误分类处理</h3> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span>File<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>io<span class="token punctuation">::</span>ErrorKind<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> f <span class="token operator">=</span> File<span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;hello.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> f <span class="token operator">=</span> <span class="token keyword">match</span> f <span class="token punctuation">{</span>
        <span class="token function">Ok</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> file<span class="token punctuation">,</span>
        <span class="token function">Err</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">match</span> error<span class="token punctuation">.</span><span class="token function">kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ErrorKind<span class="token punctuation">::</span>NotFound <span class="token operator">=&gt;</span> <span class="token keyword">match</span> File<span class="token punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;hello.txt&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">Ok</span><span class="token punctuation">(</span>fc<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> fc<span class="token punctuation">,</span>
                <span class="token function">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;创建文件失败: {:?}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            other_error <span class="token operator">=&gt;</span> <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;打开文件失败: {:?}&quot;</span><span class="token punctuation">,</span> other_error<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>使用闭包的进阶写法：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span>File<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>io<span class="token punctuation">::</span>ErrorKind<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> f <span class="token operator">=</span> File<span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;hello.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>error<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> error<span class="token punctuation">.</span><span class="token function">kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ErrorKind<span class="token punctuation">::</span>NotFound <span class="token punctuation">{</span>
            File<span class="token punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;hello.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap_or_else</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>error<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;创建文件失败: {:?}&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;打开文件失败: {:?}&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="简化调用-panic"><a href="#简化调用-panic" class="header-anchor">#</a> 简化调用 <code>panic!</code></h2> <p><code>Result&lt;T, E&gt;</code> 类型定义了很多辅助方法来处理各种情况</p> <h3 id="unwrap-方法"><a href="#unwrap-方法" class="header-anchor">#</a> <code>unwrap</code> 方法</h3> <p>使用 <code>match</code> 比较麻烦且不直观，作为替代，可以使用 <code>unwrap</code> 方法，如果 <code>Result</code> 值是成员 <code>Ok</code>，<code>unwrap</code> 返回 <code>Ok</code> 中的值，反之 <code>unwrap</code> 会调用 <code>panic!</code> 宏。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span>File<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> f <span class="token operator">=</span> File<span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;hello.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="expect-方法"><a href="#expect-方法" class="header-anchor">#</a> <code>expect</code> 方法</h3> <p><code>expect</code> 方法允许自定义 <code>panic!</code> 的错误信息，而不像 <code>unwrap</code> 那样使用默认的 <code>panic!</code> 信息，使用 <code>expect</code> 而不是 <code>unwrap</code> 可以提供直观友好的错误信息，更易于追踪 <code>panic</code> 的源头。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span>File<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> f <span class="token operator">=</span> File<span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;hello.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to open hello.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="错误传递"><a href="#错误传递" class="header-anchor">#</a> 错误传递</h2> <p>除了在当前位置处理错误外，还可以选择将错误传递给上级调用者让其决定该如何处理，这样能更好的控制代码调用，因为比起错误所在的上下文，调用者可能拥有更多信息或逻辑来决定如何处理错误。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>io<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>io<span class="token punctuation">::</span>Read<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span>File<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">read_username_from_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> io<span class="token punctuation">::</span>Error<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> f <span class="token operator">=</span> File<span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;hello.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> f <span class="token operator">=</span> <span class="token keyword">match</span> f <span class="token punctuation">{</span>
        <span class="token function">Ok</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> file<span class="token punctuation">,</span>
        <span class="token function">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">match</span> f<span class="token punctuation">.</span><span class="token function">read_to_string</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">Ok</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">Ok</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="使用-运算符代替-match-表达式简化代码"><a href="#使用-运算符代替-match-表达式简化代码" class="header-anchor">#</a> 使用 <code>?</code> 运算符代替 <code>match</code> 表达式简化代码</h3> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>io<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>io<span class="token punctuation">::</span>Read<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span>File<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">read_username_from_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> io<span class="token punctuation">::</span>Error<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> f <span class="token operator">=</span> File<span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;hello.txt&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    f<span class="token punctuation">.</span><span class="token function">read_to_string</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token function">Ok</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="运算符与match-表达式的不同"><a href="#运算符与match-表达式的不同" class="header-anchor">#</a> <code>?</code> 运算符与<code>match</code> 表达式的不同</h4> <p><code>?</code> 所使用的错误值被传递给了 <code>from</code> 函数（ 定义于标准库的 <code>From</code> 特质，用来将错误从一种类型转换为另一种类型 ）。当 <code>?</code> 调用 <code>from</code> 函数时，收到的错误类型被转换为定义为当前函数返回的错误类型。这在当一个函数返回一个错误类型来代表所有可能失败的方式时很有用，即使其可能会因很多种原因失败。只要每一个错误类型都实现了 <code>from</code> 函数来定义如何将其转换为返回的错误类型，<code>?</code> 会自动处理这些转换。</p> <h4 id="运算符的链式调用"><a href="#运算符的链式调用" class="header-anchor">#</a> <code>?</code> 运算符的链式调用</h4> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>io<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>io<span class="token punctuation">::</span>Read<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span>File<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">read_username_from_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> io<span class="token punctuation">::</span>Error<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    File<span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;hello.txt&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">read_to_string</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token function">Ok</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="极简写法"><a href="#极简写法" class="header-anchor">#</a> 极简写法</h4> <p>将文件读取到一个字符串是很常见的操作，因此 Rust 提供了 <code>fs::read_to_string</code> 函数，它会打开文件、新建一个 <code>String</code>、读取文件的内容，将内容放入 <code>String</code> 并返回。</p> <p>只是这种写法无法用于演示错误处理而已。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>io<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>fs<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">read_username_from_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> io<span class="token punctuation">::</span>Error<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">::</span><span class="token function">read_to_string</span><span class="token punctuation">(</span><span class="token string">&quot;hello.txt&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="运算符的适用条件"><a href="#运算符的适用条件" class="header-anchor">#</a> <code>?</code> 运算符的适用条件</h4> <p>只能在返回 <code>Result</code>、<code>Option</code> 或者其他实现了 <code>std::ops::Try</code> 特质的类型的函数中使用 <code>?</code> 运算符，在不返回 <code>Result</code> 的函数中调用返回 <code>Result</code> 的函数时，需要使用 <code>match</code> 或 <code>Result</code> 的方法之一来处理，而不能用 <code>?</code> 将潜在错误传递给调用方。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span>File<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 错误：cannot use the `?` operator in a function that returns `()`</span>
    <span class="token keyword">let</span> f <span class="token operator">=</span> File<span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;hello.txt&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>由于 <code>main</code> 函数的返回值类型是 <code>()</code>，会得到错误，不过 <code>main</code> 函数可以返回 <code>Result&lt;T, E&gt;</code>：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>error<span class="token punctuation">::</span>Error<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span>File<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Box<span class="token operator">&lt;</span><span class="token keyword">dyn</span> Error<span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> f <span class="token operator">=</span> File<span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;hello.txt&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="返回-result-还是-panic"><a href="#返回-result-还是-panic" class="header-anchor">#</a> @ 返回 <code>Result</code> 还是 <code>panic</code></h2> <h3 id="适用返回-result-的情况"><a href="#适用返回-result-的情况" class="header-anchor">#</a> 适用返回 <code>Result</code> 的情况</h3> <h4 id="定义可能会失败的函数"><a href="#定义可能会失败的函数" class="header-anchor">#</a> 定义可能会失败的函数</h4> <p>对被调用者来说，选择对任何错误场景都调用 <code>panic!</code>，不管错误是否可恢复（ 如果 panic，就没有恢复的可能 ），是代替调用者做决定。选择返回 <code>Result</code> 值则是将选择权交给了调用者，而不是代替他们做决定。</p> <p>对调用者来说，可能会选择以合适的方式尝试恢复 <code>Err</code>，也可能认为 <code>Err</code> 是不可恢复的，所以调用者也可能会调用 <code>panic!</code>，将可恢复的错误变成不可恢复的错误。</p> <p>因此，在定义可能会失败的函数时，返回 <code>Result</code> 是一个比较好的默认选择。</p> <h3 id="适用-panic-的情况"><a href="#适用-panic-的情况" class="header-anchor">#</a> 适用 <code>panic</code> 的情况</h3> <h4 id="示例、原型代码、测试"><a href="#示例、原型代码、测试" class="header-anchor">#</a> 示例、原型代码、测试</h4> <h4 id="当确定比编译器知道更多的情况时"><a href="#当确定比编译器知道更多的情况时" class="header-anchor">#</a> 当确定比编译器知道更多的情况时</h4> <h4 id="有可能会导致有害状态的情况"><a href="#有可能会导致有害状态的情况" class="header-anchor">#</a> 有可能会导致有害状态的情况</h4> <p>有害状态：</p> <ul><li>当假设、保证、协议或不可变性被打破的状态（ 无效的值、自相矛盾的值、被传递了不存在的值 ）</li> <li>有害状态并不包含预期会偶尔发生的错误</li> <li>之后的代码的运行依赖于处于这种有害状态</li> <li>当没有可行的手段来将有害状态信息编码进所使用的类型中的情况</li></ul> <p>具体情况：</p> <ul><li>如果代码被传递了一个没有意义的值，使用 panic 可以警告调用者注意其代码中的问题</li> <li>在调用不能够控制的外部代码时，无法修复其返回的无效状态时</li> <li>错误预期会出现时，返回 Result 要比 panic 更为合适，将有害状态向上传播，调用者可以决定该如何处理有害状态</li> <li>当代码对值进行操作时，首先应该验证值是有效的，并在其无效时 panic</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/control-flow.html" class="prev">流程控制</a></span> <span class="next"><a href="/comment.html">注释</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7819f68a.js" defer></script><script src="/assets/js/2.c7e95d31.js" defer></script><script src="/assets/js/29.e5fde72d.js" defer></script>
  </body>
</html>
